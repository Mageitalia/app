<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mage Italia v3.1 - Versione Migliorata</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== HEADER ===== */
        header {
            background: linear-gradient(135deg, #8B2635 0%, #6b1f2a 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(139, 38, 53, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        header h1 {
            font-size: 28px;
            font-weight: bold;
        }

        .welcome-box {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .welcome-text {
            font-size: 14px;
            margin-bottom: 5px;
            opacity: 0.95;
        }

        .welcome-name {
            font-size: 18px;
            font-weight: bold;
        }

        .welcome-role {
            font-size: 12px;
            opacity: 0.85;
            margin-top: 3px;
        }

        .logout-btn {
            background: white;
            color: #8B2635;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #FFD700;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* ===== LOGIN PAGE ===== */
        .login-container {
            max-width: 420px;
            margin: 60px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .login-container h2 {
            margin-bottom: 10px;
            color: #8B2635;
            font-size: 28px;
        }

        .login-container p {
            color: #999;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #8B2635;
            box-shadow: 0 0 8px rgba(139, 38, 53, 0.2);
        }

        button {
            background: linear-gradient(135deg, #8B2635 0%, #6b1f2a 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 38, 53, 0.3);
        }

        .main-content {
            display: none;
        }

        .main-content.active {
            display: block;
        }

        .page {
            display: none;
            background: white;
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .page.active {
            display: block;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 35px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
            padding: 12px 22px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            border-color: #8B2635;
            color: #8B2635;
        }

        .nav-btn.active {
            background: #8B2635;
            color: white;
            border-color: #8B2635;
        }

        /* ===== TABLES ===== */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th,
        table td {
            border: 1px solid #e0e0e0;
            padding: 14px;
            text-align: left;
        }

        table th {
            background: linear-gradient(135deg, #8B2635 0%, #6b1f2a 100%);
            color: white;
            font-weight: 600;
        }

        table tr:nth-child(even) {
            background: #fafafa;
        }

        table tr:hover {
            background: #f0f0f0;
        }

        /* ===== MESSAGES ===== */
        .message {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .success {
            background: #d4edda;
            color: #155724;
            border-color: #28a745;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #17a2b8;
        }

        /* ===== STATS ===== */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: linear-gradient(135deg, #8B2635 0%, #6b1f2a 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(139, 38, 53, 0.2);
            transition: transform 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-5px);
        }

        .stat-box h3 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .stat-box p {
            font-size: 14px;
            opacity: 0.95;
        }

        /* ===== CATEGORY SECTIONS ===== */
        .categoria-section {
            margin-bottom: 40px;
        }

        .categoria-title {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            color: #8B2635;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #8B2635;
        }

        .categoria-title span {
            font-size: 28px;
            margin-right: 12px;
        }

        .prodotti-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .prodotto-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #8B2635;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .prodotto-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-3px);
        }

        .prodotto-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .prodotto-card h3 {
            margin: 0;
            color: #8B2635;
            font-size: 16px;
        }

        .prodotto-code {
            background: #FFD700;
            color: #333;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .prodotto-card p {
            font-size: 12px;
            color: #999;
            margin-bottom: 15px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-row input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }

        .input-row input:focus {
            outline: none;
            border-color: #8B2635;
            box-shadow: 0 0 4px rgba(139, 38, 53, 0.2);
        }

        .input-row label {
            font-size: 11px;
            color: #666;
            min-width: 70px;
        }

        /* ===== FORM GROUPS ===== */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* ===== BUTTON GROUPS ===== */
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn-group button {
            flex: 1;
            min-width: 140px;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* ===== ADMIN TABS ===== */
        .admin-tab {
            display: none;
        }

        .admin-tab.active {
            display: block;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
        }

        .tab-btn {
            background: transparent;
            color: #666;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #8B2635;
        }

        .tab-btn.active {
            color: #8B2635;
            border-bottom-color: #8B2635;
        }

        /* ===== OPERATORE ONLY ===== */
        .operatore-only {
            display: none;
        }

        .operatore-only.show {
            display: block;
        }

        /* ===== ADMIN ONLY ===== */
        .admin-only {
            display: none;
        }

        .admin-only.show {
            display: block;
        }

        h2 {
            color: #8B2635;
            margin-bottom: 20px;
            font-size: 24px;
        }

        h3 {
            color: #8B2635;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 18px;
        }
    </style>
</head>
<body>

<!-- ===== LOGIN PAGE ===== -->
<div id="loginPage" class="login-container">
    <h2>üçΩÔ∏è Mage Italia</h2>
    <p>Sistema di Gestione Scarti Alimentari v3.1</p>
    
    <form id="loginForm">
        <div class="form-group">
            <label>üìß Email</label>
            <input type="email" id="email" required placeholder="admin@test.com">
        </div>
        
        <div class="form-group">
            <label>üîê Password</label>
            <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        
        <button type="submit">Accedi</button>
        
        <div id="loginError" class="message error" style="display: none; margin-top: 15px;"></div>
    </form>

    <div style="margin-top: 25px; padding-top: 25px; border-top: 1px solid #e0e0e0; text-align: center; color: #999; font-size: 12px;">
        <p><strong>Credenziali Test:</strong></p>
        <p>üë®‚Äçüíº Admin: amministrazionemageitalia@gmail.com</p>
        <p>üë§ Operatore: operatore1@test.com</p>
        <p style="margin-top: 10px; opacity: 0.7;">Password: Test123456!</p>
    </div>
</div>

<!-- ===== MAIN APP ===== -->
<div id="mainApp" class="main-content">
    <div class="container">
        <header>
            <div class="logo-section">
                <h1>üçΩÔ∏è Mage Italia</h1>
            </div>
            <div class="welcome-box">
                <div class="welcome-text">Benvenuto</div>
                <div class="welcome-name" id="welcomeName">Antonio Rossi</div>
                <div class="welcome-role" id="welcomeRole">üë®‚Äçüíº Amministratore</div>
            </div>
            <button class="logout-btn" onclick="logout()">Esci</button>
        </header>

        <!-- NAVIGATION -->
        <div class="nav-buttons" id="navButtons">
            <button class="nav-btn active" onclick="showPage('dashboard')">üìä Dashboard</button>
            <button class="nav-btn" onclick="showPage('scarti')">‚úèÔ∏è Compila Scarti</button>
            <button class="nav-btn admin-only" onclick="showPage('admin')">‚öôÔ∏è Amministrazione</button>
        </div>

        <!-- ===== DASHBOARD PAGE ===== -->
        <div id="dashboard" class="page active">
            <h2>üìä Dashboard</h2>
            
            <div class="stats">
                <div class="stat-box">
                    <h3 id="statInserimenti">0</h3>
                    <p>üìù Inserimenti Oggi</p>
                </div>
                <div class="stat-box">
                    <h3 id="statProdotti">0</h3>
                    <p>üçï Prodotti Attivi</p>
                </div>
                <div class="stat-box">
                    <h3 id="statOperatori">0</h3>
                    <p>üë• Operatori Attivi</p>
                </div>
            </div>

            <h3>üìã Ultimi Inserimenti</h3>
            <table id="ultimiInserimenti">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Operatore</th>
                        <th>Prodotto</th>
                        <th>Codice</th>
                        <th>Recuperati</th>
                        <th>Buttati</th>
                    </tr>
                </thead>
                <tbody id="tabellaInserimenti">
                </tbody>
            </table>
        </div>

        <!-- ===== COMPILA SCARTI PAGE ===== -->
        <div id="scarti" class="page operatore-only show">
            <h2>‚úèÔ∏è Compila Scarti Giornalieri</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üìÖ Data</label>
                    <input type="date" id="dataScarti" required>
                </div>

                <div class="form-group">
                    <label>üè™ Punto Vendita</label>
                    <select id="puntoVendita" required onchange="loadProdottiScarti()">
                        <option value="">Seleziona...</option>
                        <option value="pisa">Pisa</option>
                        <option value="sesto">Sesto Fiorentino</option>
                        <option value="cosenza">Cosenza</option>
                    </select>
                </div>
            </div>

            <!-- DOLCI -->
            <div class="categoria-section">
                <div class="categoria-title">
                    <span>üç∞</span>
                    <span>DOLCI</span>
                </div>
                <div class="prodotti-grid" id="prodottiDolci"></div>
            </div>

            <!-- SALATI -->
            <div class="categoria-section">
                <div class="categoria-title">
                    <span>ü•ñ</span>
                    <span>SALATI</span>
                </div>
                <div class="prodotti-grid" id="prodottiSalati"></div>
            </div>

            <div class="btn-group">
                <button onclick="salvaaScarti()">üíæ Salva Scarti</button>
                <button class="btn-secondary" onclick="resettaScarti()">üîÑ Azzera Tutto</button>
            </div>

            <div id="scartiMessage"></div>
        </div>

        <!-- ===== AMMINISTRAZIONE PAGE ===== -->
        <div id="admin" class="page admin-only">
            <h2>‚öôÔ∏è Amministrazione</h2>
            
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchAdminTab('dashboard')">üìä Dashboard</button>
                <button class="tab-btn" onclick="switchAdminTab('dipendenti')">üë• Dipendenti</button>
                <button class="tab-btn" onclick="switchAdminTab('prodotti')">üçï Prodotti</button>
                <button class="tab-btn" onclick="switchAdminTab('report')">üìÑ Report</button>
            </div>

            <!-- TAB: Dashboard Admin -->
            <div id="tabDashboard" class="admin-tab active">
                <h3>Panoramica Sistema</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Elemento</th>
                            <th>Quantit√†</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Punti Vendita</td>
                            <td id="countPunti">0</td>
                        </tr>
                        <tr>
                            <td>Dipendenti Attivi</td>
                            <td id="countDip">0</td>
                        </tr>
                        <tr>
                            <td>Prodotti Attivi</td>
                            <td id="countProd">0</td>
                        </tr>
                        <tr>
                            <td>Inserimenti Totali</td>
                            <td id="countInser">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- TAB: Dipendenti -->
            <div id="tabDipendenti" class="admin-tab">
                <h3>Aggiungi Dipendente</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" id="dipNome" placeholder="Nome">
                    </div>
                    <div class="form-group">
                        <label>Cognome</label>
                        <input type="text" id="dipCognome" placeholder="Cognome">
                    </div>
                    <div class="form-group">
                        <label>Punto Vendita</label>
                        <select id="dipPunto">
                            <option value="pisa">Pisa</option>
                            <option value="sesto">Sesto Fiorentino</option>
                            <option value="cosenza">Cosenza</option>
                        </select>
                    </div>
                </div>
                <button onclick="aggiungiDipendente()">‚ûï Aggiungi Dipendente</button>

                <h3>Dipendenti Attuali</h3>
                <table id="tabellaDipendenti">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Cognome</th>
                            <th>Punto</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="corpoDipendenti"></tbody>
                </table>
            </div>

            <!-- TAB: Prodotti -->
            <div id="tabProdotti" class="admin-tab">
                <h3>Aggiungi Prodotto</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome Prodotto</label>
                        <input type="text" id="prodNome" placeholder="Es: Cornetto">
                    </div>
                    <div class="form-group">
                        <label>Codice Prodotto</label>
                        <input type="text" id="prodCodice" placeholder="Es: 6387">
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="prodCategoria">
                            <option value="dolce">üç∞ Dolce</option>
                            <option value="salato">ü•ñ Salato</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Punto Vendita</label>
                        <select id="prodPunto">
                            <option value="pisa">Pisa</option>
                            <option value="sesto">Sesto Fiorentino</option>
                            <option value="cosenza">Cosenza</option>
                        </select>
                    </div>
                </div>
                <button onclick="aggiungiProdotto()">‚ûï Aggiungi Prodotto</button>

                <h3>Prodotti Attuali</h3>
                <table id="tabellaProdotti">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Codice</th>
                            <th>Categoria</th>
                            <th>Punto</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="corpoProdotti"></tbody>
                </table>
            </div>

            <!-- TAB: Report -->
            <div id="tabReport" class="admin-tab">
                <h3>Genera Report Excel</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data Inizio</label>
                        <input type="date" id="reportDataInizio">
                    </div>
                    <div class="form-group">
                        <label>Data Fine</label>
                        <input type="date" id="reportDataFine">
                    </div>
                    <div class="form-group">
                        <label>Tipo Report</label>
                        <select id="reportTipo">
                            <option value="giornaliero">üìã Giornaliero</option>
                            <option value="riepilogo">üìä Riepilogo Prodotto</option>
                        </select>
                    </div>
                </div>
                <button onclick="generaReport()">üì• Genera Report Excel</button>

                <div id="adminMessage"></div>
            </div>

            <div id="adminMessage" style="margin-top: 20px;"></div>
        </div>
    </div>
</div>

<script>
    // =========== CONFIG ===========
    const SUPABASE_URL = 'https://uoeprypjgybmpfstnrih.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvZXByeXBqZ3libXBmc3RucmloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MDcyNDAsImV4cCI6MjA4MDE4MzI0MH0.dDlthk4idy21aWEldrqB1U9-5awh42rC9v6fa0_mFyI';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    let currentRole = null;
    let currentNome = null;
    let scartiForm = {};

    // =========== LOGIN ===========
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');

        try {
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });

            if (error) throw error;

            currentUser = data.user;
            
            // Leggi metadati
            const metadata = currentUser.user_metadata || {};
            currentRole = metadata.role || 'operatore';
            currentNome = metadata.nome || 'Utente';

            // Mostra app
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');

            // Personalizza benvenuto
            const emoji = currentRole === 'admin' ? 'üë®‚Äçüíº' : 'üë§';
            const roleText = currentRole === 'admin' ? 'Amministratore' : 'Operatore';
            const nomeCapitalizzato = currentNome.charAt(0).toUpperCase() + currentNome.slice(1).toLowerCase();
            
            document.getElementById('welcomeName').textContent = nomeCapitalizzato;
            document.getElementById('welcomeRole').textContent = `${emoji} ${roleText}`;

            // Mostra/nascondi elementi in base al ruolo
            if (currentRole === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('show'));
                document.querySelectorAll('.operatore-only').forEach(el => el.classList.remove('show'));
            } else {
                document.querySelectorAll('.operatore-only').forEach(el => el.classList.add('show'));
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('show'));
            }

            // Carica dati
            await loadDashboard();
            await loadScartiForm();
            if (currentRole === 'admin') {
                await loadAdminData();
            }

            // Imposta date
            document.getElementById('dataScarti').valueAsDate = new Date();
            document.getElementById('reportDataInizio').valueAsDate = new Date(new Date().setDate(new Date().getDate() - 7));
            document.getElementById('reportDataFine').valueAsDate = new Date();

        } catch (err) {
            errorDiv.textContent = '‚ùå Errore: ' + err.message;
            errorDiv.style.display = 'block';
        }
    });

    // =========== LOGOUT ===========
    async function logout() {
        await supabase.auth.signOut();
        currentUser = null;
        currentRole = null;
        currentNome = null;
        document.getElementById('loginPage').style.display = 'block';
        document.getElementById('mainApp').classList.remove('active');
        document.getElementById('loginForm').reset();
    }

    // =========== NAVIGATION ===========
    function showPage(pageName) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageName).classList.add('active');
        
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    function switchAdminTab(tabName) {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    // =========== DASHBOARD ===========
    async function loadDashboard() {
        try {
            const { count: prodCount } = await supabase
                .from('prodotti')
                .select('*', { count: 'exact', head: true })
                .eq('attivo', true);

            const { count: dipCount } = await supabase
                .from('dipendenti')
                .select('*', { count: 'exact', head: true })
                .eq('attivo', true);

            const today = new Date().toISOString().split('T')[0];
            const { count: inserCount } = await supabase
                .from('registrazioni_giornaliere')
                .select('*', { count: 'exact', head: true })
                .eq('data_registrazione', today);

            document.getElementById('statProdotti').textContent = prodCount || 0;
            document.getElementById('statOperatori').textContent = dipCount || 0;
            document.getElementById('statInserimenti').textContent = inserCount || 0;

            // Ultimi inserimenti
            const { data: inserimenti } = await supabase
                .from('registrazioni_giornaliere')
                .select(`
                    id,
                    data_registrazione,
                    recuperati,
                    buttati,
                    dipendenti(nome, cognome),
                    prodotti(nome, codice_prodotto)
                `)
                .order('created_at', { ascending: false })
                .limit(10);

            const tbody = document.getElementById('tabellaInserimenti');
            tbody.innerHTML = '';
            
            if (inserimenti) {
                inserimenti.forEach(ins => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${ins.data_registrazione}</td>
                        <td>${ins.dipendenti ? ins.dipendenti.nome + ' ' + ins.dipendenti.cognome : '-'}</td>
                        <td>${ins.prodotti ? ins.prodotti.nome : '-'}</td>
                        <td><span class="prodotto-code">${ins.prodotti ? ins.prodotti.codice_prodotto : '-'}</span></td>
                        <td><strong>${ins.recuperati}</strong></td>
                        <td><strong>${ins.buttati}</strong></td>
                    `;
                });
            }

        } catch (err) {
            console.error('Dashboard error:', err);
        }
    }

    // =========== SCARTI ===========
    async function loadScartiForm() {
        try {
            document.getElementById('puntoVendita').value = 'pisa';
            await loadProdottiScarti();
        } catch (err) {
            console.error('Scarti form error:', err);
        }
    }

    async function loadProdottiScarti() {
        try {
            const punto = document.getElementById('puntoVendita').value;
            if (!punto) return;

            const { data: prodotti } = await supabase
                .from('prodotti')
                .select('*')
                .eq('punto_vendita_id', punto)
                .eq('attivo', true)
                .order('categoria', { ascending: true })
                .order('nome', { ascending: true });

            const gridDolci = document.getElementById('prodottiDolci');
            const gridSalati = document.getElementById('prodottiSalati');
            gridDolci.innerHTML = '';
            gridSalati.innerHTML = '';
            scartiForm = {};

            if (prodotti) {
                prodotti.forEach(p => {
                    scartiForm[p.id] = { recuperati: 0, buttati: 0 };
                    
                    const card = document.createElement('div');
                    card.className = 'prodotto-card';
                    card.innerHTML = `
                        <div class="prodotto-header">
                            <h3>${p.nome}</h3>
                            <div class="prodotto-code">${p.codice_prodotto}</div>
                        </div>
                        <div class="input-row">
                            <div style="flex: 1;">
                                <label>‚úÖ Recuperati</label>
                                <input type="number" min="0" placeholder="0" 
                                       onchange="scartiForm[${p.id}].recuperati = parseInt(this.value || 0)">
                            </div>
                            <div style="flex: 1;">
                                <label>‚ùå Buttati</label>
                                <input type="number" min="0" placeholder="0"
                                       onchange="scartiForm[${p.id}].buttati = parseInt(this.value || 0)">
                            </div>
                        </div>
                    `;
                    
                    if (p.categoria === 'dolce') {
                        gridDolci.appendChild(card);
                    } else {
                        gridSalati.appendChild(card);
                    }
                });
            }

        } catch (err) {
            console.error('Prodotti scarti error:', err);
        }
    }

    async function salvaaScarti() {
        try {
            const data = document.getElementById('dataScarti').value;
            const punto = document.getElementById('puntoVendita').value;

            if (!data || !punto) {
                showMessage('scartiMessage', '‚ö†Ô∏è Seleziona data e punto vendita', 'error');
                return;
            }

            // Se √® operatore, usa l'ID dal metadata
            let dipId = null;
            if (currentRole === 'operatore' && currentUser.user_metadata) {
                // Per operatori, cerchiamo il dipendente corrispondente
                const { data: dip } = await supabase
                    .from('dipendenti')
                    .select('id')
                    .eq('nome', currentNome)
                    .limit(1);
                
                if (dip && dip.length > 0) {
                    dipId = dip[0].id;
                }
            }

            if (!dipId && currentRole === 'operatore') {
                showMessage('scartiMessage', '‚ö†Ô∏è Operatore non trovato nel sistema', 'error');
                return;
            }

            const registrazioni = [];
            for (const [prodId, valori] of Object.entries(scartiForm)) {
                if (valori.recuperati > 0 || valori.buttati > 0) {
                    registrazioni.push({
                        data_registrazione: data,
                        punto_vendita_id: punto,
                        dipendente_id: dipId,
                        prodotto_id: parseInt(prodId),
                        recuperati: valori.recuperati,
                        buttati: valori.buttati
                    });
                }
            }

            if (registrazioni.length === 0) {
                showMessage('scartiMessage', '‚ö†Ô∏è Aggiungi almeno uno scarto', 'error');
                return;
            }

            const { error } = await supabase
                .from('registrazioni_giornaliere')
                .insert(registrazioni);

            if (error) throw error;

            showMessage('scartiMessage', '‚úÖ Scarti salvati con successo!', 'success');
            resettaScarti();
            await loadDashboard();

        } catch (err) {
            showMessage('scartiMessage', '‚ùå Errore: ' + err.message, 'error');
        }
    }

    function resettaScarti() {
        document.getElementById('dataScarti').valueAsDate = new Date();
        document.querySelectorAll('.prodotto-card input').forEach(input => input.value = '');
        scartiForm = {};
    }

    // =========== ADMIN ===========
    async function loadAdminData() {
        await loadAdminDashboard();
        await loadDipendentiAdmin();
        await loadProdottiAdmin();
    }

    async function loadAdminDashboard() {
        try {
            const { count: punti } = await supabase.from('punti_vendita').select('*', { count: 'exact', head: true });
            const { count: dip } = await supabase.from('dipendenti').select('*', { count: 'exact', head: true }).eq('attivo', true);
            const { count: prod } = await supabase.from('prodotti').select('*', { count: 'exact', head: true }).eq('attivo', true);
            const { count: inser } = await supabase.from('registrazioni_giornaliere').select('*', { count: 'exact', head: true });

            document.getElementById('countPunti').textContent = punti || 0;
            document.getElementById('countDip').textContent = dip || 0;
            document.getElementById('countProd').textContent = prod || 0;
            document.getElementById('countInser').textContent = inser || 0;
        } catch (err) {
            console.error('Admin dashboard error:', err);
        }
    }

    async function loadDipendentiAdmin() {
        try {
            const { data: dipendenti } = await supabase
                .from('dipendenti')
                .select('*')
                .order('nome');

            const tbody = document.getElementById('corpoDipendenti');
            tbody.innerHTML = '';

            if (dipendenti) {
                dipendenti.forEach(d => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${d.nome}</td>
                        <td>${d.cognome}</td>
                        <td>${d.punto_vendita_id}</td>
                        <td><button class="btn-danger" onclick="eliminaDipendente(${d.id})" style="width: 100%; padding: 8px;">‚ùå Elimina</button></td>
                    `;
                });
            }

        } catch (err) {
            console.error('Load dipendenti error:', err);
        }
    }

    async function aggiungiDipendente() {
        try {
            const nome = document.getElementById('dipNome').value;
            const cognome = document.getElementById('dipCognome').value;
            const punto = document.getElementById('dipPunto').value;

            if (!nome || !cognome) {
                showMessage('adminMessage', '‚ö†Ô∏è Compila nome e cognome', 'error');
                return;
            }

            const { error } = await supabase
                .from('dipendenti')
                .insert([{ nome, cognome, punto_vendita_id: punto, attivo: true }]);

            if (error) throw error;

            document.getElementById('dipNome').value = '';
            document.getElementById('dipCognome').value = '';
            showMessage('adminMessage', '‚úÖ Dipendente aggiunto!', 'success');
            await loadDipendentiAdmin();

        } catch (err) {
            showMessage('adminMessage', '‚ùå Errore: ' + err.message, 'error');
        }
    }

    async function eliminaDipendente(id) {
        if (!confirm('Sei sicuro di voler eliminare questo dipendente?')) return;
        try {
            const { error } = await supabase
                .from('dipendenti')
                .update({ attivo: false })
                .eq('id', id);

            if (error) throw error;
            await loadDipendentiAdmin();
        } catch (err) {
            alert('‚ùå Errore: ' + err.message);
        }
    }

    async function loadProdottiAdmin() {
        try {
            const { data: prodotti } = await supabase
                .from('prodotti')
                .select('*')
                .order('nome');

            const tbody = document.getElementById('corpoProdotti');
            tbody.innerHTML = '';

            if (prodotti) {
                prodotti.forEach(p => {
                    const row = tbody.insertRow();
                    const emoji = p.categoria === 'dolce' ? 'üç∞' : 'ü•ñ';
                    row.innerHTML = `
                        <td>${p.nome}</td>
                        <td><span class="prodotto-code">${p.codice_prodotto}</span></td>
                        <td>${emoji} ${p.categoria}</td>
                        <td>${p.punto_vendita_id}</td>
                        <td><button class="btn-danger" onclick="eliminaProdotto(${p.id})" style="width: 100%; padding: 8px;">‚ùå Elimina</button></td>
                    `;
                });
            }

        } catch (err) {
            console.error('Load prodotti error:', err);
        }
    }

    async function aggiungiProdotto() {
        try {
            const nome = document.getElementById('prodNome').value;
            const codice = document.getElementById('prodCodice').value;
            const categoria = document.getElementById('prodCategoria').value;
            const punto = document.getElementById('prodPunto').value;

            if (!nome || !codice) {
                showMessage('adminMessage', '‚ö†Ô∏è Compila nome e codice', 'error');
                return;
            }

            const { error } = await supabase
                .from('prodotti')
                .insert([{
                    nome,
                    codice_prodotto: codice,
                    categoria,
                    punto_vendita_id: punto,
                    attivo: true
                }]);

            if (error) throw error;

            document.getElementById('prodNome').value = '';
            document.getElementById('prodCodice').value = '';
            showMessage('adminMessage', '‚úÖ Prodotto aggiunto!', 'success');
            await loadProdottiAdmin();

        } catch (err) {
            showMessage('adminMessage', '‚ùå Errore: ' + err.message, 'error');
        }
    }

    async function eliminaProdotto(id) {
        if (!confirm('Sei sicuro di voler eliminare questo prodotto?')) return;
        try {
            const { error } = await supabase
                .from('prodotti')
                .update({ attivo: false })
                .eq('id', id);

            if (error) throw error;
            await loadProdottiAdmin();
        } catch (err) {
            alert('‚ùå Errore: ' + err.message);
        }
    }

    async function generaReport() {
        try {
            const dataInizio = document.getElementById('reportDataInizio').value;
            const dataFine = document.getElementById('reportDataFine').value;
            const tipo = document.getElementById('reportTipo').value;

            if (!dataInizio || !dataFine) {
                showMessage('adminMessage', '‚ö†Ô∏è Seleziona le date', 'error');
                return;
            }

            const { data: registrazioni } = await supabase
                .from('registrazioni_giornaliere')
                .select(`
                    *,
                    dipendenti(nome, cognome),
                    prodotti(nome, categoria, codice_prodotto),
                    punti_vendita(nome)
                `)
                .gte('data_registrazione', dataInizio)
                .lte('data_registrazione', dataFine)
                .order('data_registrazione');

            if (!registrazioni || registrazioni.length === 0) {
                showMessage('adminMessage', '‚ÑπÔ∏è Nessun dato nel periodo selezionato', 'info');
                return;
            }

            const wb = XLSX.utils.book_new();

            if (tipo === 'giornaliero') {
                const byDay = {};
                registrazioni.forEach(r => {
                    if (!byDay[r.data_registrazione]) byDay[r.data_registrazione] = [];
                    byDay[r.data_registrazione].push(r);
                });

                Object.entries(byDay).forEach(([day, dati]) => {
                    const wsData = [
                        ['Data', 'Operatore', 'Prodotto', 'Codice', 'Categoria', 'Recuperati', 'Buttati']
                    ];
                    
                    dati.forEach(d => {
                        wsData.push([
                            d.data_registrazione,
                            d.dipendenti ? d.dipendenti.nome + ' ' + d.dipendenti.cognome : '',
                            d.prodotti ? d.prodotti.nome : '',
                            d.prodotti ? d.prodotti.codice_prodotto : '',
                            d.prodotti ? d.prodotti.categoria : '',
                            d.recuperati,
                            d.buttati
                        ]);
                    });

                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    XLSX.utils.book_append_sheet(wb, ws, day);
                });
            } else {
                const byProd = {};
                registrazioni.forEach(r => {
                    const key = r.prodotto_id;
                    if (!byProd[key]) byProd[key] = { nome: '', codice: '', categoria: '', recuperati: 0, buttati: 0 };
                    if (r.prodotti) {
                        byProd[key].nome = r.prodotti.nome;
                        byProd[key].codice = r.prodotti.codice_prodotto;
                        byProd[key].categoria = r.prodotti.categoria;
                    }
                    byProd[key].recuperati += r.recuperati;
                    byProd[key].buttati += r.buttati;
                });

                const wsData = [
                    ['Prodotto', 'Codice', 'Categoria', 'Recuperati Totali', 'Buttati Totali']
                ];

                Object.values(byProd).forEach(p => {
                    wsData.push([p.nome, p.codice, p.categoria, p.recuperati, p.buttati]);
                });

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Riepilogo');
            }

            XLSX.writeFile(wb, `Mage-Italia-Report-${dataInizio}.xlsx`);
            showMessage('adminMessage', '‚úÖ Report scaricato!', 'success');

        } catch (err) {
            showMessage('adminMessage', '‚ùå Errore: ' + err.message, 'error');
        }
    }

    // =========== UTILITY ===========
    function showMessage(elementId, message, type) {
        const div = document.getElementById(elementId);
        div.className = 'message ' + type;
        div.textContent = message;
        div.style.display = 'block';
        setTimeout(() => { div.style.display = 'none'; }, 4000);
    }

</script>

</body>
</html>

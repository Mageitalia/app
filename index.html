<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mage Italia v3.0 - Simple Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #8B2635;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 24px;
        }

        .logout-btn {
            background: white;
            color: #8B2635;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .logout-btn:hover {
            background: #f0f0f0;
        }

        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .login-container h2 {
            margin-bottom: 20px;
            color: #8B2635;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #8B2635;
            box-shadow: 0 0 5px rgba(139, 38, 53, 0.3);
        }

        button {
            background: #8B2635;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            width: 100%;
        }

        button:hover {
            background: #6b1f2a;
        }

        .main-content {
            display: none;
        }

        .main-content.active {
            display: block;
        }

        .page {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .page.active {
            display: block;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: #8B2635;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .nav-btn.active {
            background: #FFD700;
            color: #8B2635;
        }

        .nav-btn:hover {
            opacity: 0.9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th,
        table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        table th {
            background: #8B2635;
            color: white;
        }

        table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .scarti-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .prodotto-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #8B2635;
        }

        .prodotto-card h3 {
            margin-bottom: 10px;
            color: #8B2635;
        }

        .prodotto-card .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .prodotto-card input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: linear-gradient(135deg, #8B2635 0%, #6b1f2a 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box h3 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-box p {
            font-size: 14px;
            opacity: 0.9;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-group button {
            flex: 1;
            min-width: 150px;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8B2635;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage" class="login-container">
    <h2>üçΩÔ∏è Mage Italia v3.0</h2>
    <p style="margin-bottom: 20px; color: #666;">Sistema di Gestione Scarti Alimentari</p>
    
    <form id="loginForm">
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="email" required placeholder="admin@test.com">
        </div>
        
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        
        <button type="submit">Accedi</button>
        
        <div id="loginError" class="message error" style="display: none; margin-top: 15px;"></div>
    </form>
    
    <p style="margin-top: 20px; font-size: 12px; color: #999;">
        Versione 3.0 - Simple Edition<br>
        Powered by Supabase
    </p>
</div>

<!-- MAIN APP -->
<div id="mainApp" class="main-content">
    <div class="container">
        <header>
            <h1>üçΩÔ∏è Mage Italia v3.0</h1>
            <div>
                <span id="userEmail" style="margin-right: 20px;"></span>
                <button class="logout-btn" onclick="logout()">Esci</button>
            </div>
        </header>

        <!-- NAVIGATION -->
        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showPage('dashboard')">üìä Dashboard</button>
            <button class="nav-btn" onclick="showPage('scarti')">‚úèÔ∏è Compila Scarti</button>
            <button class="nav-btn" onclick="showPage('admin')">‚öôÔ∏è Amministrazione</button>
        </div>

        <!-- DASHBOARD PAGE -->
        <div id="dashboard" class="page active">
            <h2>üìä Dashboard</h2>
            
            <div class="stats">
                <div class="stat-box">
                    <h3 id="statInserimenti">0</h3>
                    <p>Inserimenti Oggi</p>
                </div>
                <div class="stat-box">
                    <h3 id="statProdotti">0</h3>
                    <p>Prodotti Attivi</p>
                </div>
                <div class="stat-box">
                    <h3 id="statOperatori">0</h3>
                    <p>Operatori Attivi</p>
                </div>
            </div>

            <h3>Ultimi Inserimenti</h3>
            <table id="ultimiInserimenti">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Operatore</th>
                        <th>Prodotto</th>
                        <th>Recuperati</th>
                        <th>Buttati</th>
                    </tr>
                </thead>
                <tbody id="tabellaInserimenti">
                </tbody>
            </table>
        </div>

        <!-- COMPILA SCARTI PAGE -->
        <div id="scarti" class="page">
            <h2>‚úèÔ∏è Compila Scarti</h2>
            
            <div class="form-group">
                <label>Data</label>
                <input type="date" id="dataScarti" required>
            </div>

            <div class="form-group">
                <label>Punto Vendita</label>
                <select id="puntoVendita" required>
                    <option value="">Seleziona...</option>
                    <option value="pisa">Pisa</option>
                    <option value="sesto">Sesto Fiorentino</option>
                    <option value="cosenza">Cosenza</option>
                </select>
            </div>

            <div class="form-group">
                <label>Operatore</label>
                <select id="operatore" required>
                    <option value="">Seleziona...</option>
                </select>
            </div>

            <h3>Prodotti</h3>
            <div class="scarti-grid" id="prodottiGrid"></div>

            <div class="btn-group">
                <button onclick="salvaaScarti()">üíæ Salva Scarti</button>
                <button onclick="resettaScarti()">üîÑ Azzera</button>
            </div>

            <div id="scartiMessage"></div>
        </div>

        <!-- AMMINISTRAZIONE PAGE -->
        <div id="admin" class="page">
            <h2>‚öôÔ∏è Amministrazione</h2>
            
            <div style="border-bottom: 1px solid #ddd; margin-bottom: 20px;">
                <button class="nav-btn" onclick="switchAdminTab('dipendenti')" style="width: auto;">üë• Dipendenti</button>
                <button class="nav-btn" onclick="switchAdminTab('prodotti')" style="width: auto;">üçï Prodotti</button>
                <button class="nav-btn" onclick="switchAdminTab('report')" style="width: auto;">üìÑ Report</button>
            </div>

            <!-- TAB: Dipendenti -->
            <div id="tabDipendenti" class="admin-tab active">
                <h3>Aggiungi Dipendente</h3>
                <div class="form-group">
                    <label>Nome</label>
                    <input type="text" id="dipNome" placeholder="Nome">
                </div>
                <div class="form-group">
                    <label>Cognome</label>
                    <input type="text" id="dipCognome" placeholder="Cognome">
                </div>
                <div class="form-group">
                    <label>Punto Vendita</label>
                    <select id="dipPunto">
                        <option value="pisa">Pisa</option>
                        <option value="sesto">Sesto Fiorentino</option>
                        <option value="cosenza">Cosenza</option>
                    </select>
                </div>
                <button onclick="aggiungiDipendente()">Aggiungi Dipendente</button>

                <h3 style="margin-top: 30px;">Dipendenti Attuali</h3>
                <table id="tabellaD ipendenti">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Cognome</th>
                            <th>Punto</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="corpoDipendenti"></tbody>
                </table>
            </div>

            <!-- TAB: Prodotti -->
            <div id="tabProdotti" class="admin-tab" style="display: none;">
                <h3>Aggiungi Prodotto</h3>
                <div class="form-group">
                    <label>Nome Prodotto</label>
                    <input type="text" id="prodNome" placeholder="Es: Cornetto">
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="prodCategoria">
                        <option value="dolce">Dolce</option>
                        <option value="salato">Salato</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Punto Vendita</label>
                    <select id="prodPunto">
                        <option value="pisa">Pisa</option>
                        <option value="sesto">Sesto Fiorentino</option>
                        <option value="cosenza">Cosenza</option>
                    </select>
                </div>
                <button onclick="aggiungiProdotto()">Aggiungi Prodotto</button>

                <h3 style="margin-top: 30px;">Prodotti Attuali</h3>
                <table id="tabellaProdotti">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Categoria</th>
                            <th>Punto</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="corpoProdotti"></tbody>
                </table>
            </div>

            <!-- TAB: Report -->
            <div id="tabReport" class="admin-tab" style="display: none;">
                <h3>Genera Report Excel</h3>
                <div class="form-group">
                    <label>Data Inizio</label>
                    <input type="date" id="reportDataInizio">
                </div>
                <div class="form-group">
                    <label>Data Fine</label>
                    <input type="date" id="reportDataFine">
                </div>
                <div class="form-group">
                    <label>Tipo Report</label>
                    <select id="reportTipo">
                        <option value="giornaliero">Giornaliero</option>
                        <option value="riepilogo">Riepilogo Prodotto</option>
                    </select>
                </div>
                <button onclick="generaReport()">üìä Genera Report Excel</button>
            </div>

            <div id="adminMessage"></div>
        </div>
    </div>
</div>

<script>
    // =========== CONFIG ===========
    const SUPABASE_URL = 'https://uoeprypjgybmpfstnrih.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvZXByeXBqZ3libXBmc3RucmloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MDcyNDAsImV4cCI6MjA4MDE4MzI0MH0.dDlthk4idy21aWEldrqB1U9-5awh42rC9v6fa0_mFyI';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    let scartiForm = {};

    // =========== LOGIN ===========
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');

        try {
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });

            if (error) throw error;

            currentUser = data.user;
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
            document.getElementById('userEmail').textContent = email;

            // Carica dati iniziali
            await loadDashboard();
            await loadScartiForm();
            await loadAdminData();

            // Imposta date
            document.getElementById('dataScarti').valueAsDate = new Date();
            document.getElementById('reportDataInizio').valueAsDate = new Date(new Date().setDate(new Date().getDate() - 7));
            document.getElementById('reportDataFine').valueAsDate = new Date();

        } catch (err) {
            errorDiv.textContent = 'Errore: ' + err.message;
            errorDiv.style.display = 'block';
        }
    });

    // =========== LOGOUT ===========
    async function logout() {
        await supabase.auth.signOut();
        currentUser = null;
        document.getElementById('loginPage').style.display = 'block';
        document.getElementById('mainApp').classList.remove('active');
        document.getElementById('loginForm').reset();
    }

    // =========== NAVIGATION ===========
    function showPage(pageName) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageName).classList.add('active');
        
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    function switchAdminTab(tabName) {
        document.querySelectorAll('.admin-tab').forEach(t => t.style.display = 'none');
        document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).style.display = 'block';
    }

    // =========== DASHBOARD ===========
    async function loadDashboard() {
        try {
            // Conteggi
            const { count: prodCount } = await supabase
                .from('prodotti')
                .select('*', { count: 'exact', head: true })
                .eq('attivo', true);

            const { count: dipCount } = await supabase
                .from('dipendenti')
                .select('*', { count: 'exact', head: true })
                .eq('attivo', true);

            const today = new Date().toISOString().split('T')[0];
            const { count: inserCount } = await supabase
                .from('registrazioni_giornaliere')
                .select('*', { count: 'exact', head: true })
                .eq('data_registrazione', today);

            document.getElementById('statProdotti').textContent = prodCount || 0;
            document.getElementById('statOperatori').textContent = dipCount || 0;
            document.getElementById('statInserimenti').textContent = inserCount || 0;

            // Ultimi inserimenti
            const { data: inserimenti } = await supabase
                .from('registrazioni_giornaliere')
                .select(`
                    id,
                    data_registrazione,
                    recuperati,
                    buttati,
                    dipendenti(nome, cognome),
                    prodotti(nome)
                `)
                .order('created_at', { ascending: false })
                .limit(10);

            const tbody = document.getElementById('tabellaInserimenti');
            tbody.innerHTML = '';
            
            if (inserimenti) {
                inserimenti.forEach(ins => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${ins.data_registrazione}</td>
                        <td>${ins.dipendenti ? ins.dipendenti.nome + ' ' + ins.dipendenti.cognome : '-'}</td>
                        <td>${ins.prodotti ? ins.prodotti.nome : '-'}</td>
                        <td>${ins.recuperati}</td>
                        <td>${ins.buttati}</td>
                    `;
                });
            }

        } catch (err) {
            console.error('Dashboard error:', err);
        }
    }

    // =========== SCARTI ===========
    async function loadScartiForm() {
        try {
            const { data: dipendenti } = await supabase
                .from('dipendenti')
                .select('*')
                .eq('attivo', true)
                .order('nome');

            const selectOp = document.getElementById('operatore');
            selectOp.innerHTML = '<option value="">Seleziona...</option>';
            
            if (dipendenti) {
                dipendenti.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.id;
                    opt.textContent = d.nome + ' ' + d.cognome;
                    selectOp.appendChild(opt);
                });
            }

            // Carica prodotti per punto
            document.getElementById('puntoVendita').addEventListener('change', loadProdottiScarti);

            // Carica primo punto
            document.getElementById('puntoVendita').value = 'pisa';
            await loadProdottiScarti();

        } catch (err) {
            console.error('Scarti form error:', err);
        }
    }

    async function loadProdottiScarti() {
        try {
            const punto = document.getElementById('puntoVendita').value;
            if (!punto) return;

            const { data: prodotti } = await supabase
                .from('prodotti')
                .select('*')
                .eq('punto_vendita_id', punto)
                .eq('attivo', true)
                .order('categoria', { ascending: true })
                .order('nome', { ascending: true });

            const grid = document.getElementById('prodottiGrid');
            grid.innerHTML = '';
            scartiForm = {};

            if (prodotti) {
                prodotti.forEach(p => {
                    scartiForm[p.id] = { recuperati: 0, buttati: 0 };
                    
                    const card = document.createElement('div');
                    card.className = 'prodotto-card';
                    card.innerHTML = `
                        <h3>${p.nome}</h3>
                        <p style="font-size: 12px; color: #999;">Categoria: ${p.categoria}</p>
                        <div class="input-row">
                            <input type="number" min="0" placeholder="Recuperati" 
                                   onchange="scartiForm[${p.id}].recuperati = parseInt(this.value || 0)">
                            <input type="number" min="0" placeholder="Buttati"
                                   onchange="scartiForm[${p.id}].buttati = parseInt(this.value || 0)">
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }

        } catch (err) {
            console.error('Prodotti scarti error:', err);
        }
    }

    async function salvaaScarti() {
        try {
            const data = document.getElementById('dataScarti').value;
            const punto = document.getElementById('puntoVendita').value;
            const operatore = document.getElementById('operatore').value;

            if (!data || !punto || !operatore) {
                showMessage('scartiMessage', 'Compila tutti i campi', 'error');
                return;
            }

            const registrazioni = [];
            for (const [prodId, valori] of Object.entries(scartiForm)) {
                if (valori.recuperati > 0 || valori.buttati > 0) {
                    registrazioni.push({
                        data_registrazione: data,
                        punto_vendita_id: punto,
                        dipendente_id: parseInt(operatore),
                        prodotto_id: parseInt(prodId),
                        recuperati: valori.recuperati,
                        buttati: valori.buttati
                    });
                }
            }

            if (registrazioni.length === 0) {
                showMessage('scartiMessage', 'Aggiungi almeno uno scarto', 'error');
                return;
            }

            const { error } = await supabase
                .from('registrazioni_giornaliere')
                .insert(registrazioni);

            if (error) throw error;

            showMessage('scartiMessage', '‚úÖ Scarti salvati con successo!', 'success');
            resettaScarti();
            await loadDashboard();

        } catch (err) {
            showMessage('scartiMessage', 'Errore: ' + err.message, 'error');
        }
    }

    function resettaScarti() {
        document.getElementById('dataScarti').valueAsDate = new Date();
        document.getElementById('operatore').value = '';
        document.querySelectorAll('.prodotto-card input').forEach(input => input.value = '');
    }

    // =========== ADMIN ===========
    async function loadAdminData() {
        await loadDipendentiAdmin();
        await loadProdottiAdmin();
    }

    async function loadDipendentiAdmin() {
        try {
            const { data: dipendenti } = await supabase
                .from('dipendenti')
                .select('*')
                .order('nome');

            const tbody = document.getElementById('corpoDipendenti');
            tbody.innerHTML = '';

            if (dipendenti) {
                dipendenti.forEach(d => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${d.nome}</td>
                        <td>${d.cognome}</td>
                        <td>${d.punto_vendita_id}</td>
                        <td><button onclick="eliminaDipendente(${d.id})" style="background: #dc3545; width: 100%;">Elimina</button></td>
                    `;
                });
            }

        } catch (err) {
            console.error('Load dipendenti error:', err);
        }
    }

    async function aggiungiDipendente() {
        try {
            const nome = document.getElementById('dipNome').value;
            const cognome = document.getElementById('dipCognome').value;
            const punto = document.getElementById('dipPunto').value;

            if (!nome || !cognome) {
                showMessage('adminMessage', 'Compila nome e cognome', 'error');
                return;
            }

            const { error } = await supabase
                .from('dipendenti')
                .insert([{ nome, cognome, punto_vendita_id: punto, attivo: true }]);

            if (error) throw error;

            document.getElementById('dipNome').value = '';
            document.getElementById('dipCognome').value = '';
            showMessage('adminMessage', '‚úÖ Dipendente aggiunto!', 'success');
            await loadDipendentiAdmin();

        } catch (err) {
            showMessage('adminMessage', 'Errore: ' + err.message, 'error');
        }
    }

    async function eliminaDipendente(id) {
        if (!confirm('Sei sicuro?')) return;
        try {
            const { error } = await supabase
                .from('dipendenti')
                .update({ attivo: false })
                .eq('id', id);

            if (error) throw error;
            await loadDipendentiAdmin();
        } catch (err) {
            alert('Errore: ' + err.message);
        }
    }

    async function loadProdottiAdmin() {
        try {
            const { data: prodotti } = await supabase
                .from('prodotti')
                .select('*')
                .order('nome');

            const tbody = document.getElementById('corpoProdotti');
            tbody.innerHTML = '';

            if (prodotti) {
                prodotti.forEach(p => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${p.nome}</td>
                        <td>${p.categoria}</td>
                        <td>${p.punto_vendita_id}</td>
                        <td><button onclick="eliminaProdotto(${p.id})" style="background: #dc3545; width: 100%;">Elimina</button></td>
                    `;
                });
            }

        } catch (err) {
            console.error('Load prodotti error:', err);
        }
    }

    async function aggiungiProdotto() {
        try {
            const nome = document.getElementById('prodNome').value;
            const categoria = document.getElementById('prodCategoria').value;
            const punto = document.getElementById('prodPunto').value;

            if (!nome) {
                showMessage('adminMessage', 'Compila il nome del prodotto', 'error');
                return;
            }

            const { error } = await supabase
                .from('prodotti')
                .insert([{
                    nome,
                    categoria,
                    punto_vendita_id: punto,
                    attivo: true
                }]);

            if (error) throw error;

            document.getElementById('prodNome').value = '';
            showMessage('adminMessage', '‚úÖ Prodotto aggiunto!', 'success');
            await loadProdottiAdmin();

        } catch (err) {
            showMessage('adminMessage', 'Errore: ' + err.message, 'error');
        }
    }

    async function eliminaProdotto(id) {
        if (!confirm('Sei sicuro?')) return;
        try {
            const { error } = await supabase
                .from('prodotti')
                .update({ attivo: false })
                .eq('id', id);

            if (error) throw error;
            await loadProdottiAdmin();
        } catch (err) {
            alert('Errore: ' + err.message);
        }
    }

    async function generaReport() {
        try {
            const dataInizio = document.getElementById('reportDataInizio').value;
            const dataFine = document.getElementById('reportDataFine').value;
            const tipo = document.getElementById('reportTipo').value;

            if (!dataInizio || !dataFine) {
                showMessage('adminMessage', 'Seleziona le date', 'error');
                return;
            }

            const { data: registrazioni } = await supabase
                .from('registrazioni_giornaliere')
                .select(`
                    *,
                    dipendenti(nome, cognome),
                    prodotti(nome, categoria),
                    punti_vendita(nome)
                `)
                .gte('data_registrazione', dataInizio)
                .lte('data_registrazione', dataFine)
                .order('data_registrazione');

            if (!registrazioni || registrazioni.length === 0) {
                showMessage('adminMessage', 'Nessun dato nel periodo selezionato', 'info');
                return;
            }

            const wb = XLSX.utils.book_new();

            if (tipo === 'giornaliero') {
                // Un foglio per giorno
                const byDay = {};
                registrazioni.forEach(r => {
                    if (!byDay[r.data_registrazione]) byDay[r.data_registrazione] = [];
                    byDay[r.data_registrazione].push(r);
                });

                Object.entries(byDay).forEach(([day, dati]) => {
                    const wsData = [
                        ['Data', 'Operatore', 'Prodotto', 'Categoria', 'Recuperati', 'Buttati']
                    ];
                    
                    dati.forEach(d => {
                        wsData.push([
                            d.data_registrazione,
                            d.dipendenti ? d.dipendenti.nome + ' ' + d.dipendenti.cognome : '',
                            d.prodotti ? d.prodotti.nome : '',
                            d.prodotti ? d.prodotti.categoria : '',
                            d.recuperati,
                            d.buttati
                        ]);
                    });

                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    XLSX.utils.book_append_sheet(wb, ws, day);
                });
            } else {
                // Riepilogo per prodotto
                const byProd = {};
                registrazioni.forEach(r => {
                    const key = r.prodotto_id;
                    if (!byProd[key]) byProd[key] = { nome: '', categoria: '', recuperati: 0, buttati: 0 };
                    if (r.prodotti) {
                        byProd[key].nome = r.prodotti.nome;
                        byProd[key].categoria = r.prodotti.categoria;
                    }
                    byProd[key].recuperati += r.recuperati;
                    byProd[key].buttati += r.buttati;
                });

                const wsData = [
                    ['Prodotto', 'Categoria', 'Recuperati Totali', 'Buttati Totali']
                ];

                Object.values(byProd).forEach(p => {
                    wsData.push([p.nome, p.categoria, p.recuperati, p.buttati]);
                });

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Riepilogo');
            }

            XLSX.writeFile(wb, `Mage-Italia-Report-${dataInizio}.xlsx`);
            showMessage('adminMessage', '‚úÖ Report scaricato!', 'success');

        } catch (err) {
            showMessage('adminMessage', 'Errore: ' + err.message, 'error');
        }
    }

    // =========== UTILITY ===========
    function showMessage(elementId, message, type) {
        const div = document.getElementById(elementId);
        div.className = 'message ' + type;
        div.textContent = message;
        div.style.display = 'block';
        setTimeout(() => { div.style.display = 'none'; }, 4000);
    }

</script>

</body>
</html>

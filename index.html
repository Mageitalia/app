<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mage Italia v4.0 - Sistema Gestione Scarti</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== LOGIN PAGE ===== */
        .login-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #8B2635 0%, #6b1f2a 100%);
        }

        .login-container {
            background: white;
            padding: 50px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }

        .logo-section {
            margin-bottom: 30px;
        }

        .logo-img {
            max-width: 150px;
            height: auto;
            margin-bottom: 20px;
        }

        .login-container h1 {
            color: #8B2635;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-container p {
            color: #999;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #8B2635;
            box-shadow: 0 0 8px rgba(139, 38, 53, 0.2);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #8B2635 0%, #6b1f2a 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 38, 53, 0.3);
        }

        #loginError {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
        }

        /* ===== HEADER APP ===== */
        header {
            background: linear-gradient(135deg, #8B2635 0%, #6b1f2a 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(139, 38, 53, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo {
            max-width: 60px;
        }

        .header-logo img {
            max-width: 100%;
            height: auto;
        }

        header h1 {
            font-size: 24px;
        }

        .welcome-box {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 20px;
            border-radius: 8px;
        }

        .welcome-text {
            font-size: 14px;
            opacity: 0.9;
        }

        .welcome-name {
            font-size: 16px;
            font-weight: bold;
        }

        .welcome-role {
            font-size: 12px;
            opacity: 0.85;
        }

        .logout-btn {
            background: white;
            color: #8B2635;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #FFD700;
            transform: translateY(-2px);
        }

        /* ===== MAIN APP ===== */
        .main-content {
            display: none;
        }

        .main-content.active {
            display: block;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
            padding: 12px 22px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: #8B2635;
            color: white;
            border-color: #8B2635;
        }

        .page {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .page.active {
            display: block;
        }

        h2 {
            color: #8B2635;
            margin-bottom: 25px;
            font-size: 24px;
        }

        h3 {
            color: #8B2635;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 18px;
        }

        /* ===== STATS ===== */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: linear-gradient(135deg, #8B2635 0%, #6b1f2a 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(139, 38, 53, 0.2);
        }

        .stat-box h3 {
            font-size: 32px;
            margin: 0 0 10px 0;
            color: white;
        }

        .stat-box p {
            font-size: 14px;
            opacity: 0.95;
            margin: 0;
        }

        /* ===== CHARTS ===== */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin: 30px 0;
        }

        .chart-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .chart-box h3 {
            margin-top: 0;
            margin-bottom: 20px;
        }

        /* ===== SEARCH & CATEGORIES ===== */
        .search-container {
            margin-bottom: 30px;
        }

        .search-box {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .search-box:focus {
            outline: none;
            border-color: #8B2635;
            box-shadow: 0 0 8px rgba(139, 38, 53, 0.2);
        }

        /* ===== PREFERITI ===== */
        .preferiti-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
            border: 2px solid #FFD700;
        }

        .preferiti-title {
            color: #8B2635;
            margin-bottom: 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preferiti-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .preferito-btn {
            background: white;
            border: 2px solid #8B2635;
            color: #8B2635;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            text-align: center;
            transition: all 0.3s;
        }

        .preferito-btn:hover {
            background: #8B2635;
            color: white;
        }

        /* ===== CATEGORIE PRODOTTI ===== */
        .categoria-section {
            margin-bottom: 40px;
        }

        .categoria-title {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            color: #8B2635;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #8B2635;
        }

        .categoria-title span {
            font-size: 28px;
            margin-right: 12px;
        }

        .prodotti-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .prodotto-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #8B2635;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .prodotto-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-3px);
        }

        .prodotto-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .prodotto-card h4 {
            margin: 0;
            color: #8B2635;
            font-size: 15px;
        }

        .prodotto-code {
            background: #FFD700;
            color: #333;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-row > div {
            flex: 1;
        }

        .input-row label {
            display: block;
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .input-row input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }

        .input-row input:focus {
            outline: none;
            border-color: #8B2635;
            box-shadow: 0 0 4px rgba(139, 38, 53, 0.2);
        }

        /* ===== TABLES ===== */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th, table td {
            border: 1px solid #e0e0e0;
            padding: 12px;
            text-align: left;
        }

        table th {
            background: linear-gradient(135deg, #8B2635 0%, #6b1f2a 100%);
            color: white;
            font-weight: 600;
        }

        table tr:nth-child(even) {
            background: #fafafa;
        }

        /* ===== BUTTONS ===== */
        button {
            background: linear-gradient(135deg, #8B2635 0%, #6b1f2a 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 38, 53, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn-group button {
            flex: 1;
            min-width: 140px;
        }

        /* ===== MESSAGES ===== */
        .message {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .success {
            background: #d4edda;
            color: #155724;
            border-color: #28a745;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #17a2b8;
        }

        /* ===== FORM ===== */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #8B2635;
            box-shadow: 0 0 4px rgba(139, 38, 53, 0.2);
        }

        /* ===== ADMIN TABS ===== */
        .admin-only {
            display: none;
        }

        .admin-only.show {
            display: block;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: transparent;
            color: #666;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #8B2635;
            border-bottom-color: #8B2635;
        }

        .admin-tab {
            display: none;
        }

        .admin-tab.active {
            display: block;
        }

        .operatore-only {
            display: none;
        }

        .operatore-only.show {
            display: block;
        }
    </style>
</head>
<body>

<!-- ===== LOGIN PAGE ===== -->
<div id="loginPage" class="login-wrapper">
    <div class="login-container">
        <div class="logo-section">
            <img id="loginLogo" class="logo-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" alt="Logo">
            <h1>Mage Italia</h1>
            <p>Sistema Gestione Scarti Alimentari v4.0</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label>üìß Email</label>
                <input type="email" id="email" required placeholder="operatore@mageitalita.com">
            </div>
            
            <div class="form-group">
                <label>üîê Password</label>
                <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            
            <button type="submit" class="login-btn">Accedi</button>
            
            <div id="loginError" style="display: none; margin-top: 15px;"></div>
        </form>
    </div>
</div>

<!-- ===== MAIN APP ===== -->
<div id="mainApp" class="main-content">
    <div class="container">
        <header>
            <div class="header-left">
                <div class="header-logo">
                    <img id="appLogo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" alt="Logo">
                </div>
                <div>
                    <h1>Mage Italia</h1>
                </div>
            </div>
            <div class="welcome-box">
                <div class="welcome-text">Benvenuto</div>
                <div class="welcome-name" id="welcomeName">Antonio</div>
                <div class="welcome-role" id="welcomeRole">üë®‚Äçüíº Amministratore</div>
            </div>
            <button class="logout-btn" onclick="logout()">üö™ Esci</button>
        </header>

        <!-- NAVIGATION -->
        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showPage('dashboard')">üìä Dashboard</button>
            <button class="nav-btn operatore-only show" onclick="showPage('scarti')">‚úèÔ∏è Compila Scarti</button>
            <button class="nav-btn admin-only" onclick="showPage('admin')">‚öôÔ∏è Amministrazione</button>
        </div>

        <!-- ===== DASHBOARD PAGE ===== -->
        <div id="dashboard" class="page active">
            <h2>üìä Dashboard</h2>
            
            <div class="stats">
                <div class="stat-box">
                    <h3 id="statInserimenti">0</h3>
                    <p>üìù Inserimenti Oggi</p>
                </div>
                <div class="stat-box">
                    <h3 id="statProdotti">0</h3>
                    <p>üçï Prodotti Attivi</p>
                </div>
                <div class="stat-box">
                    <h3 id="statOperatori">0</h3>
                    <p>üë• Operatori Attivi</p>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-box">
                    <h3>üìä Recuperati vs Buttati (Oggi)</h3>
                    <canvas id="chartRecuperatiVsButtati"></canvas>
                </div>
                <div class="chart-box">
                    <h3>üç∞ Dolci vs ü•ñ Salati</h3>
                    <canvas id="chartDolciSalati"></canvas>
                </div>
            </div>

            <h3>üìã Ultimi Inserimenti</h3>
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Operatore</th>
                        <th>Prodotto</th>
                        <th>Codice</th>
                        <th>Recuperati</th>
                        <th>Buttati</th>
                    </tr>
                </thead>
                <tbody id="tabellaInserimenti">
                </tbody>
            </table>
        </div>

        <!-- ===== COMPILA SCARTI PAGE ===== -->
        <div id="scarti" class="page operatore-only show">
            <h2>‚úèÔ∏è Compila Scarti Giornalieri</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üìÖ Data</label>
                    <input type="date" id="dataScarti" required>
                </div>
                <div class="form-group">
                    <label>üè™ Punto Vendita</label>
                    <select id="puntoVendita" required onchange="loadProdottiScarti()">
                        <option value="">Seleziona...</option>
                        <option value="pisa">Pisa</option>
                        <option value="sesto">Sesto Fiorentino</option>
                        <option value="cosenza">Cosenza</option>
                    </select>
                </div>
            </div>

            <!-- SEARCH & PREFERITI -->
            <div class="search-container">
                <input type="text" id="searchProdotto" class="search-box" placeholder="üîç Cerca per nome o codice...">
                
                <div class="preferiti-section">
                    <div class="preferiti-title">‚≠ê PREFERITI (I Pi√π Usati)</div>
                    <div class="preferiti-grid" id="preferitiGrid"></div>
                </div>
            </div>

            <!-- DOLCI -->
            <div class="categoria-section">
                <div class="categoria-title">
                    <span>üç∞</span>
                    <span>DOLCI</span>
                </div>
                <div class="prodotti-grid" id="prodottiDolci"></div>
            </div>

            <!-- SALATI -->
            <div class="categoria-section">
                <div class="categoria-title">
                    <span>ü•ñ</span>
                    <span>SALATI</span>
                </div>
                <div class="prodotti-grid" id="prodottiSalati"></div>
            </div>

            <div class="btn-group">
                <button onclick="salvaaScarti()">üíæ Salva Scarti</button>
                <button class="btn-secondary" onclick="resettaScarti()">üîÑ Azzera Tutto</button>
            </div>

            <div id="scartiMessage"></div>
        </div>

        <!-- ===== AMMINISTRAZIONE PAGE ===== -->
        <div id="admin" class="page admin-only">
            <h2>‚öôÔ∏è Amministrazione</h2>
            
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchAdminTab('utenti')">üë§ Gestione Utenti</button>
                <button class="tab-btn" onclick="switchAdminTab('dipendenti')">üë• Dipendenti</button>
                <button class="tab-btn" onclick="switchAdminTab('prodotti')">üçï Prodotti</button>
                <button class="tab-btn" onclick="switchAdminTab('report')">üìÑ Report</button>
                <button class="tab-btn" onclick="switchAdminTab('logo')">üñºÔ∏è Logo</button>
            </div>

            <!-- TAB: Gestione Utenti -->
            <div id="tabUtenti" class="admin-tab active">
                <h3>‚ûï Crea Nuovo Operatore</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" id="opNome" placeholder="Marco">
                    </div>
                    <div class="form-group">
                        <label>Cognome</label>
                        <input type="text" id="opCognome" placeholder="Rossi">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="opEmail" placeholder="marco.rossi@mageitalita.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="opPassword" placeholder="Password123!">
                    </div>
                    <div class="form-group">
                        <label>Punto Vendita</label>
                        <select id="opPunto">
                            <option value="pisa">Pisa</option>
                            <option value="sesto">Sesto Fiorentino</option>
                            <option value="cosenza">Cosenza</option>
                        </select>
                    </div>
                </div>
                <button onclick="creaOperatore()">‚ûï Crea Operatore</button>

                <h3 style="margin-top: 40px;">üë• Operatori Attuali</h3>
                <table id="tabellaOperatori">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Punto</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="corpoOperatori"></tbody>
                </table>

                <div id="utentiMessage"></div>
            </div>

            <!-- TAB: Dipendenti -->
            <div id="tabDipendenti" class="admin-tab">
                <h3>‚ûï Aggiungi Dipendente</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" id="dipNome" placeholder="Nome">
                    </div>
                    <div class="form-group">
                        <label>Cognome</label>
                        <input type="text" id="dipCognome" placeholder="Cognome">
                    </div>
                    <div class="form-group">
                        <label>Punto Vendita</label>
                        <select id="dipPunto">
                            <option value="pisa">Pisa</option>
                            <option value="sesto">Sesto Fiorentino</option>
                            <option value="cosenza">Cosenza</option>
                        </select>
                    </div>
                </div>
                <button onclick="aggiungiDipendente()">‚ûï Aggiungi Dipendente</button>

                <h3 style="margin-top: 40px;">Dipendenti Attuali</h3>
                <table id="tabellaDipendenti">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Cognome</th>
                            <th>Punto</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="corpoDipendenti"></tbody>
                </table>

                <div id="dipendentiMessage"></div>
            </div>

            <!-- TAB: Prodotti -->
            <div id="tabProdotti" class="admin-tab">
                <h3>‚ûï Aggiungi Prodotto</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome Prodotto</label>
                        <input type="text" id="prodNome" placeholder="Es: Cornetto">
                    </div>
                    <div class="form-group">
                        <label>Codice Prodotto</label>
                        <input type="text" id="prodCodice" placeholder="Es: 6387">
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="prodCategoria">
                            <option value="dolce">üç∞ Dolce</option>
                            <option value="salato">ü•ñ Salato</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Punto Vendita</label>
                        <select id="prodPunto">
                            <option value="pisa">Pisa</option>
                            <option value="sesto">Sesto Fiorentino</option>
                            <option value="cosenza">Cosenza</option>
                        </select>
                    </div>
                </div>
                <button onclick="aggiungiProdotto()">‚ûï Aggiungi Prodotto</button>

                <h3 style="margin-top: 40px;">Prodotti Attuali</h3>
                <table id="tabellaProdotti">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Codice</th>
                            <th>Categoria</th>
                            <th>Punto</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="corpoProdotti"></tbody>
                </table>

                <div id="prodottiMessage"></div>
            </div>

            <!-- TAB: Report -->
            <div id="tabReport" class="admin-tab">
                <h3>üìä Genera Report Excel</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Punto Vendita</label>
                        <select id="reportPunto">
                            <option value="">Tutti</option>
                            <option value="pisa">Pisa</option>
                            <option value="sesto">Sesto Fiorentino</option>
                            <option value="cosenza">Cosenza</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data Inizio</label>
                        <input type="date" id="reportDataInizio">
                    </div>
                    <div class="form-group">
                        <label>Data Fine</label>
                        <input type="date" id="reportDataFine">
                    </div>
                    <div class="form-group">
                        <label>Tipo Report</label>
                        <select id="reportTipo">
                            <option value="completo">üìã Completo (Dolci + Salati)</option>
                            <option value="dolce">üç∞ Solo Dolci</option>
                            <option value="salato">ü•ñ Solo Salati</option>
                            <option value="riepilogo">üìä Riepilogo Prodotto</option>
                        </select>
                    </div>
                </div>
                <button onclick="generaReport()">üì• Genera Report Excel</button>

                <div id="reportMessage"></div>
            </div>

            <!-- TAB: Logo -->
            <div id="tabLogo" class="admin-tab">
                <h3>üñºÔ∏è Carica Logo Azienda</h3>
                <p style="color: #666; margin-bottom: 20px;">Carica un'immagine per il logo (PNG, JPG). Dimensione consigliata: 200x200px</p>
                
                <div class="form-group">
                    <label>Seleziona Immagine</label>
                    <input type="file" id="logoUpload" accept="image/*">
                </div>
                
                <button onclick="salvaLogo()">üíæ Salva Logo</button>
                
                <h3 style="margin-top: 40px;">Anteprima Logo</h3>
                <div style="border: 2px dashed #ccc; padding: 20px; border-radius: 8px; text-align: center;">
                    <img id="logoPreview" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" alt="Logo Preview" style="max-width: 150px; height: auto;">
                </div>

                <div id="logoMessage"></div>
            </div>

            <div id="adminMessage"></div>
        </div>
    </div>
</div>

<script>
    // =========== CONFIG ===========
    const SUPABASE_URL = 'https://uoeprypjgybmpfstnrih.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvZXByeXBqZ3libXBmc3RucmloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MDcyNDAsImV4cCI6MjA4MDE4MzI0MH0.dDlthk4idy21aWEldrqB1U9-5awh42rC9v6fa0_mFyI';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    let currentRole = null;
    let currentNome = null;
    let scartiForm = {};
    let tuttiProdotti = [];
    let preferitiUsati = [];
    let logoBase64 = null;
    let charts = {};

    // =========== LOAD LOGO DA LOCALSTORAGE ===========
    function loadLogo() {
        const savedLogo = localStorage.getItem('mageitaliaLogo');
        if (savedLogo) {
            logoBase64 = savedLogo;
            document.getElementById('loginLogo').src = logoBase64;
            document.getElementById('appLogo').src = logoBase64;
            document.getElementById('logoPreview').src = logoBase64;
        }
    }

    loadLogo();

    // =========== AUTOLOAD SESSIONE ===========
    window.addEventListener('load', async () => {
        const { data, error } = await supabase.auth.getSession();
        if (data.session && data.session.user) {
            await handleLoginSuccess(data.session.user);
        }
    });

    async function handleLoginSuccess(user) {
        currentUser = user;
        const metadata = user.user_metadata || {};
        currentRole = metadata.role || 'operatore';
        currentNome = metadata.nome || 'Utente';

        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainApp').classList.add('active');

        const emoji = currentRole === 'admin' ? 'üë®‚Äçüíº' : 'üë§';
        const roleText = currentRole === 'admin' ? 'Amministratore' : 'Operatore';
        const nomeCapitalizzato = currentNome.charAt(0).toUpperCase() + currentNome.slice(1).toLowerCase();
        
        document.getElementById('welcomeName').textContent = nomeCapitalizzato;
        document.getElementById('welcomeRole').textContent = `${emoji} ${roleText}`;

        if (currentRole === 'admin') {
            document.querySelectorAll('.admin-only').forEach(el => el.classList.add('show'));
            document.querySelectorAll('.operatore-only').forEach(el => el.classList.remove('show'));
        } else {
            document.querySelectorAll('.operatore-only').forEach(el => el.classList.add('show'));
            document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('show'));
        }

        await loadDashboard();
        await loadScartiForm();
        if (currentRole === 'admin') {
            await loadAdminData();
        }

        document.getElementById('dataScarti').valueAsDate = new Date();
        document.getElementById('reportDataInizio').valueAsDate = new Date(new Date().setDate(new Date().getDate() - 7));
        document.getElementById('reportDataFine').valueAsDate = new Date();
    }

    // =========== LOGIN ===========
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');

        try {
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });

            if (error) throw error;

            await handleLoginSuccess(data.user);

        } catch (err) {
            errorDiv.textContent = '‚ùå Errore: ' + err.message;
            errorDiv.style.display = 'block';
        }
    });

    // =========== LOGOUT ===========
    async function logout() {
        await supabase.auth.signOut();
        currentUser = null;
        currentRole = null;
        currentNome = null;
        document.getElementById('loginPage').style.display = 'block';
        document.getElementById('mainApp').classList.remove('active');
        document.getElementById('loginForm').reset();
    }

    // =========== NAVIGATION ===========
    function showPage(pageName) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageName).classList.add('active');
        
        if (pageName === 'dashboard' && Object.keys(charts).length > 0) {
            Object.values(charts).forEach(chart => {
                if (chart) chart.resize();
            });
        }
    }

    function switchAdminTab(tabName) {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    // =========== DASHBOARD ===========
    async function loadDashboard() {
        try {
            const { count: prodCount } = await supabase
                .from('prodotti')
                .select('*', { count: 'exact', head: true })
                .eq('attivo', true);

            const { count: dipCount } = await supabase
                .from('dipendenti')
                .select('*', { count: 'exact', head: true })
                .eq('attivo', true);

            const today = new Date().toISOString().split('T')[0];
            const { count: inserCount } = await supabase
                .from('registrazioni_giornaliere')
                .select('*', { count: 'exact', head: true })
                .eq('data_registrazione', today);

            document.getElementById('statProdotti').textContent = prodCount || 0;
            document.getElementById('statOperatori').textContent = dipCount || 0;
            document.getElementById('statInserimenti').textContent = inserCount || 0;

            // Carica dati per grafici
            const { data: inserimenti } = await supabase
                .from('registrazioni_giornaliere')
                .select(`
                    id,
                    data_registrazione,
                    recuperati,
                    buttati,
                    dipendenti(nome, cognome),
                    prodotti(nome, codice_prodotto, categoria)
                `)
                .eq('data_registrazione', today)
                .order('created_at', { ascending: false });

            const tbody = document.getElementById('tabellaInserimenti');
            tbody.innerHTML = '';
            
            if (inserimenti) {
                inserimenti.forEach(ins => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${ins.data_registrazione}</td>
                        <td>${ins.dipendenti ? ins.dipendenti.nome + ' ' + ins.dipendenti.cognome : '-'}</td>
                        <td>${ins.prodotti ? ins.prodotti.nome : '-'}</td>
                        <td><span class="prodotto-code">${ins.prodotti ? ins.prodotti.codice_prodotto : '-'}</span></td>
                        <td><strong>${ins.recuperati}</strong></td>
                        <td><strong>${ins.buttati}</strong></td>
                    `;
                });
            }

            // Grafici
            const totalRecuperati = inserimenti ? inserimenti.reduce((sum, i) => sum + (i.recuperati || 0), 0) : 0;
            const totalButtati = inserimenti ? inserimenti.reduce((sum, i) => sum + (i.buttati || 0), 0) : 0;

            const dolci = inserimenti ? inserimenti.filter(i => i.prodotti && i.prodotti.categoria === 'dolce').reduce((sum, i) => sum + (i.recuperati || 0) + (i.buttati || 0), 0) : 0;
            const salati = inserimenti ? inserimenti.filter(i => i.prodotti && i.prodotti.categoria === 'salato').reduce((sum, i) => sum + (i.recuperati || 0) + (i.buttati || 0), 0) : 0;

            // Chart Recuperati vs Buttati
            const ctxChart1 = document.getElementById('chartRecuperatiVsButtati');
            if (ctxChart1) {
                if (charts.chart1) charts.chart1.destroy();
                charts.chart1 = new Chart(ctxChart1, {
                    type: 'doughnut',
                    data: {
                        labels: ['‚úÖ Recuperati', '‚ùå Buttati'],
                        datasets: [{
                            data: [totalRecuperati, totalButtati],
                            backgroundColor: ['#28a745', '#dc3545'],
                            borderColor: ['#fff', '#fff'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Chart Dolci vs Salati
            const ctxChart2 = document.getElementById('chartDolciSalati');
            if (ctxChart2) {
                if (charts.chart2) charts.chart2.destroy();
                charts.chart2 = new Chart(ctxChart2, {
                    type: 'doughnut',
                    data: {
                        labels: ['üç∞ Dolci', 'ü•ñ Salati'],
                        datasets: [{
                            data: [dolci, salati],
                            backgroundColor: ['#FFD700', '#FF6B6B'],
                            borderColor: ['#fff', '#fff'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

        } catch (err) {
            console.error('Dashboard error:', err);
        }
    }

    // =========== SCARTI ===========
    async function loadScartiForm() {
        try {
            document.getElementById('puntoVendita').value = 'pisa';
            await loadProdottiScarti();
            
            // Carica preferiti
            const saved = localStorage.getItem('preferitiMageItalia');
            if (saved) {
                preferitiUsati = JSON.parse(saved);
            }
            
            document.getElementById('searchProdotto').addEventListener('input', filterProdotti);
        } catch (err) {
            console.error('Scarti form error:', err);
        }
    }

    async function loadProdottiScarti() {
        try {
            const punto = document.getElementById('puntoVendita').value;
            if (!punto) return;

            const { data: prodotti } = await supabase
                .from('prodotti')
                .select('*')
                .eq('punto_vendita_id', punto)
                .eq('attivo', true)
                .order('categoria', { ascending: true })
                .order('nome', { ascending: true });

            tuttiProdotti = prodotti || [];
            
            renderProdotti(tuttiProdotti);
            renderPreferiti();

        } catch (err) {
            console.error('Prodotti scarti error:', err);
        }
    }

    function renderProdotti(prodotti) {
        const gridDolci = document.getElementById('prodottiDolci');
        const gridSalati = document.getElementById('prodottiSalati');
        gridDolci.innerHTML = '';
        gridSalati.innerHTML = '';
        scartiForm = {};

        prodotti.forEach(p => {
            scartiForm[p.id] = { recuperati: 0, buttati: 0 };
            
            const card = document.createElement('div');
            card.className = 'prodotto-card';
            card.innerHTML = `
                <div class="prodotto-header">
                    <h4>${p.nome}</h4>
                    <div class="prodotto-code">${p.codice_prodotto}</div>
                </div>
                <div class="input-row">
                    <div>
                        <label>‚úÖ Recuperati</label>
                        <input type="number" min="0" placeholder="0" 
                               onchange="scartiForm[${p.id}].recuperati = parseInt(this.value || 0); salvaPreferiti(${p.id});">
                    </div>
                    <div>
                        <label>‚ùå Buttati</label>
                        <input type="number" min="0" placeholder="0"
                               onchange="scartiForm[${p.id}].buttati = parseInt(this.value || 0); salvaPreferiti(${p.id});">
                    </div>
                </div>
            `;
            
            if (p.categoria === 'dolce') {
                gridDolci.appendChild(card);
            } else {
                gridSalati.appendChild(card);
            }
        });
    }

    function filterProdotti() {
        const search = document.getElementById('searchProdotto').value.toLowerCase();
        const filtered = tuttiProdotti.filter(p => 
            p.nome.toLowerCase().includes(search) || 
            p.codice_prodotto.toLowerCase().includes(search)
        );
        renderProdotti(filtered);
    }

    function renderPreferiti() {
        const grid = document.getElementById('preferitiGrid');
        grid.innerHTML = '';

        const preferiti = tuttiProdotti
            .filter(p => preferitiUsati.includes(p.id))
            .slice(0, 6);

        if (preferiti.length === 0) {
            grid.innerHTML = '<p style="color: #999; grid-column: 1/-1;">Nessun preferito ancora. Aggiungi durante la compilazione!</p>';
            return;
        }

        preferiti.forEach(p => {
            const btn = document.createElement('button');
            btn.className = 'preferito-btn';
            btn.textContent = `${p.nome.substring(0, 15)}... [${p.codice_prodotto}]`;
            btn.onclick = () => {
                const inputs = document.querySelectorAll('.prodotto-card input');
                inputs.forEach(inp => inp.value = '');
                document.querySelector(`[data-product-id="${p.id}"]`)?.focus();
            };
            grid.appendChild(btn);
        });
    }

    function salvaPreferiti(prodId) {
        if (!preferitiUsati.includes(prodId)) {
            preferitiUsati.push(prodId);
            if (preferitiUsati.length > 10) preferitiUsati.shift();
            localStorage.setItem('preferitiMageItalia', JSON.stringify(preferitiUsati));
            renderPreferiti();
        }
    }

    async function salvaaScarti() {
        try {
            const data = document.getElementById('dataScarti').value;
            const punto = document.getElementById('puntoVendita').value;

            if (!data || !punto) {
                showMessage('scartiMessage', '‚ö†Ô∏è Seleziona data e punto vendita', 'error');
                return;
            }

            // Trova dipendente corrispondente all'operatore loggato
            const { data: dip } = await supabase
                .from('dipendenti')
                .select('id')
                .eq('nome', currentNome)
                .eq('punto_vendita_id', punto)
                .limit(1);
            
            if (!dip || dip.length === 0) {
                showMessage('scartiMessage', '‚ö†Ô∏è Operatore non trovato nel sistema', 'error');
                return;
            }

            const dipId = dip[0].id;
            const registrazioni = [];

            for (const [prodId, valori] of Object.entries(scartiForm)) {
                if (valori.recuperati > 0 || valori.buttati > 0) {
                    registrazioni.push({
                        data_registrazione: data,
                        punto_vendita_id: punto,
                        dipendente_id: dipId,
                        prodotto_id: parseInt(prodId),
                        recuperati: valori.recuperati,
                        buttati: valori.buttati
                    });
                }
            }

            if (registrazioni.length === 0) {
                showMessage('scartiMessage', '‚ö†Ô∏è Aggiungi almeno uno scarto', 'error');
                return;
            }

            const { error } = await supabase
                .from('registrazioni_giornaliere')
                .insert(registrazioni);

            if (error) throw error;

            showMessage('scartiMessage', '‚úÖ Scarti salvati con successo!', 'success');
            resettaScarti();
            await loadDashboard();

        } catch (err) {
            showMessage('scartiMessage', '‚ùå Errore: ' + err.message, 'error');
        }
    }

    function resettaScarti() {
        document.getElementById('dataScarti').valueAsDate = new Date();
        document.querySelectorAll('.prodotto-card input').forEach(input => input.value = '');
        scartiForm = {};
    }

    // =========== ADMIN - GESTIONE UTENTI ===========
    // Nota: Gli utenti Supabase auth vanno creati manualmente o via API server-side
    // Per semplicit√†, usiamo localStorage per tracciare i credenziali operatori
    
    let operatoriCreati = JSON.parse(localStorage.getItem('mageitaliaOperatori')) || [];

    async function creaOperatore() {
        try {
            const nome = document.getElementById('opNome').value;
            const cognome = document.getElementById('opCognome').value;
            const email = document.getElementById('opEmail').value;
            const password = document.getElementById('opPassword').value;
            const punto = document.getElementById('opPunto').value;

            if (!nome || !cognome || !email || !password) {
                showMessage('utentiMessage', '‚ö†Ô∏è Compila tutti i campi', 'error');
                return;
            }

            // Verifica se email esiste gi√†
            const { data: existing } = await supabase.auth.signInWithPassword({ email, password: 'test' }).catch(() => ({ data: null }));
            
            // Crea in localStorage (traccia locale)
            const operatore = {
                id: Date.now().toString(),
                nome,
                cognome,
                email,
                password, // ‚ö†Ô∏è ATTENZIONE: Solo per demo! In produzione usare server-side
                punto,
                createdAt: new Date().toISOString()
            };

            operatoriCreati.push(operatore);
            localStorage.setItem('mageitaliaOperatori', JSON.stringify(operatoriCreati));

            // Crea anche dipendente in DB
            const { error: dipError } = await supabase.from('dipendenti').insert([{
                nome,
                cognome,
                punto_vendita_id: punto,
                attivo: true
            }]);

            if (dipError) console.warn('Dipendente warning:', dipError);

            document.getElementById('opNome').value = '';
            document.getElementById('opCognome').value = '';
            document.getElementById('opEmail').value = '';
            document.getElementById('opPassword').value = '';

            showMessage('utentiMessage', '‚úÖ Operatore creato! (Credenziali salvate localmente)', 'success');
            await loadOperatoriAdmin();

        } catch (err) {
            showMessage('utentiMessage', '‚ùå Errore: ' + err.message, 'error');
        }
    }

    async function loadOperatoriAdmin() {
        try {
            const tbody = document.getElementById('corpoOperatori');
            tbody.innerHTML = '';

            operatoriCreati = JSON.parse(localStorage.getItem('mageitaliaOperatori')) || [];

            if (operatoriCreati && operatoriCreati.length > 0) {
                operatoriCreati.forEach(op => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${op.nome}</td>
                        <td>${op.email}</td>
                        <td>${op.punto}</td>
                        <td><button class="btn-danger" onclick="eliminaOperatore('${op.id}')" style="width: 100%; padding: 8px;">‚ùå Elimina</button></td>
                    `;
                });
            } else {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="4" style="text-align: center; color: #999;">Nessun operatore creato</td>';
            }

        } catch (err) {
            console.error('Load operatori error:', err);
        }
    }

    async function eliminaOperatore(opId) {
        if (!confirm('Sei sicuro? L\'operatore non potr√† pi√π accedere.')) return;
        try {
            operatoriCreati = operatoriCreati.filter(op => op.id !== opId);
            localStorage.setItem('mageitaliaOperatori', JSON.stringify(operatoriCreati));
            
            showMessage('utentiMessage', '‚úÖ Operatore eliminato!', 'success');
            await loadOperatoriAdmin();
        } catch (err) {
            showMessage('utentiMessage', '‚ùå Errore: ' + err.message, 'error');
        }
    }

    // =========== ADMIN - DIPENDENTI ===========
    async function loadDipendentiAdmin() {
        try {
            const { data: dipendenti } = await supabase
                .from('dipendenti')
                .select('*')
                .order('nome');

            const tbody = document.getElementById('corpoDipendenti');
            tbody.innerHTML = '';

            if (dipendenti) {
                dipendenti.forEach(d => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${d.nome}</td>
                        <td>${d.cognome}</td>
                        <td>${d.punto_vendita_id}</td>
                        <td><button class="btn-danger" onclick="eliminaDipendente(${d.id})" style="width: 100%; padding: 8px;">‚ùå Elimina</button></td>
                    `;
                });
            }

        } catch (err) {
            console.error('Load dipendenti error:', err);
        }
    }

    async function aggiungiDipendente() {
        try {
            const nome = document.getElementById('dipNome').value;
            const cognome = document.getElementById('dipCognome').value;
            const punto = document.getElementById('dipPunto').value;

            if (!nome || !cognome) {
                showMessage('dipendentiMessage', '‚ö†Ô∏è Compila nome e cognome', 'error');
                return;
            }

            const { error } = await supabase
                .from('dipendenti')
                .insert([{ nome, cognome, punto_vendita_id: punto, attivo: true }]);

            if (error) throw error;

            document.getElementById('dipNome').value = '';
            document.getElementById('dipCognome').value = '';
            showMessage('dipendentiMessage', '‚úÖ Dipendente aggiunto!', 'success');
            await loadDipendentiAdmin();

        } catch (err) {
            showMessage('dipendentiMessage', '‚ùå Errore: ' + err.message, 'error');
        }
    }

    async function eliminaDipendente(id) {
        if (!confirm('Sei sicuro di voler eliminare questo dipendente?')) return;
        try {
            const { error } = await supabase
                .from('dipendenti')
                .update({ attivo: false })
                .eq('id', id);

            if (error) {
                console.error('Eliminate error:', error);
                throw error;
            }
            
            showMessage('dipendentiMessage', '‚úÖ Dipendente eliminato!', 'success');
            await new Promise(r => setTimeout(r, 500));
            await loadDipendentiAdmin();
            
        } catch (err) {
            console.error('Error:', err);
            showMessage('dipendentiMessage', '‚ùå Errore: ' + err.message, 'error');
        }
    }

    // =========== ADMIN - PRODOTTI ===========
    async function loadProdottiAdmin() {
        try {
            const { data: prodotti } = await supabase
                .from('prodotti')
                .select('*')
                .order('nome');

            const tbody = document.getElementById('corpoProdotti');
            tbody.innerHTML = '';

            if (prodotti) {
                prodotti.forEach(p => {
                    const row = tbody.insertRow();
                    const emoji = p.categoria === 'dolce' ? 'üç∞' : 'ü•ñ';
                    row.innerHTML = `
                        <td>${p.nome}</td>
                        <td><span class="prodotto-code">${p.codice_prodotto}</span></td>
                        <td>${emoji} ${p.categoria}</td>
                        <td>${p.punto_vendita_id}</td>
                        <td><button class="btn-danger" onclick="eliminaProdotto(${p.id})" style="width: 100%; padding: 8px;">‚ùå Elimina</button></td>
                    `;
                });
            }

        } catch (err) {
            console.error('Load prodotti error:', err);
        }
    }

    async function aggiungiProdotto() {
        try {
            const nome = document.getElementById('prodNome').value;
            const codice = document.getElementById('prodCodice').value;
            const categoria = document.getElementById('prodCategoria').value;
            const punto = document.getElementById('prodPunto').value;

            if (!nome || !codice) {
                showMessage('prodottiMessage', '‚ö†Ô∏è Compila nome e codice', 'error');
                return;
            }

            const { error } = await supabase
                .from('prodotti')
                .insert([{
                    nome,
                    codice_prodotto: codice,
                    categoria,
                    punto_vendita_id: punto,
                    attivo: true
                }]);

            if (error) throw error;

            document.getElementById('prodNome').value = '';
            document.getElementById('prodCodice').value = '';
            showMessage('prodottiMessage', '‚úÖ Prodotto aggiunto!', 'success');
            await loadProdottiAdmin();

        } catch (err) {
            showMessage('prodottiMessage', '‚ùå Errore: ' + err.message, 'error');
        }
    }

    async function eliminaProdotto(id) {
        if (!confirm('Sei sicuro di voler eliminare questo prodotto?')) return;
        try {
            const { error } = await supabase
                .from('prodotti')
                .update({ attivo: false })
                .eq('id', id);

            if (error) {
                console.error('Eliminate error:', error);
                throw error;
            }
            
            showMessage('prodottiMessage', '‚úÖ Prodotto eliminato!', 'success');
            await new Promise(r => setTimeout(r, 500));
            await loadProdottiAdmin();
            
        } catch (err) {
            console.error('Error:', err);
            showMessage('prodottiMessage', '‚ùå Errore: ' + err.message, 'error');
        }
    }

    // =========== ADMIN - REPORT ===========
    async function generaReport() {
        try {
            // Verifica che XLSX sia caricato
            if (typeof XLSX === 'undefined') {
                showMessage('reportMessage', '‚ö†Ô∏è Libreria Excel non caricata. Ricarica la pagina.', 'error');
                return;
            }

            showMessage('reportMessage', '‚è≥ Generando report...', 'info');
            
            const punto = document.getElementById('reportPunto').value || null;
            const dataInizio = document.getElementById('reportDataInizio').value;
            const dataFine = document.getElementById('reportDataFine').value;
            const tipo = document.getElementById('reportTipo').value;

            if (!dataInizio || !dataFine) {
                showMessage('reportMessage', '‚ö†Ô∏è Seleziona le date', 'error');
                return;
            }

            let query = supabase
                .from('registrazioni_giornaliere')
                .select(`
                    *,
                    dipendenti(nome, cognome),
                    prodotti(nome, categoria, codice_prodotto),
                    punti_vendita(nome)
                `)
                .gte('data_registrazione', dataInizio)
                .lte('data_registrazione', dataFine);

            if (punto) {
                query = query.eq('punto_vendita_id', punto);
            }

            const { data: registrazioni, error } = await query.order('data_registrazione');

            if (error) {
                console.error('Query error:', error);
                throw error;
            }

            if (!registrazioni || registrazioni.length === 0) {
                showMessage('reportMessage', '‚ÑπÔ∏è Nessun dato nel periodo selezionato', 'info');
                return;
            }

            const wb = XLSX.utils.book_new();

            if (tipo === 'completo') {
                const wsData = [['Data', 'Operatore', 'Prodotto', 'Codice', 'Categoria', 'Recuperati', 'Buttati']];
                
                registrazioni.forEach(r => {
                    wsData.push([
                        r.data_registrazione || '',
                        r.dipendenti ? (r.dipendenti.nome + ' ' + r.dipendenti.cognome) : '',
                        r.prodotti ? r.prodotti.nome : '',
                        r.prodotti ? r.prodotti.codice_prodotto : '',
                        r.prodotti ? r.prodotti.categoria : '',
                        r.recuperati || 0,
                        r.buttati || 0
                    ]);
                });

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Report');

            } else if (tipo === 'riepilogo') {
                const byProd = {};
                registrazioni.forEach(r => {
                    const key = r.prodotto_id;
                    if (!byProd[key]) {
                        byProd[key] = { nome: '', codice: '', categoria: '', recuperati: 0, buttati: 0 };
                    }
                    if (r.prodotti) {
                        byProd[key].nome = r.prodotti.nome;
                        byProd[key].codice = r.prodotti.codice_prodotto;
                        byProd[key].categoria = r.prodotti.categoria;
                    }
                    byProd[key].recuperati += r.recuperati || 0;
                    byProd[key].buttati += r.buttati || 0;
                });

                const wsData = [['Prodotto', 'Codice', 'Categoria', 'Recuperati', 'Buttati']];
                Object.values(byProd).forEach(p => {
                    wsData.push([p.nome, p.codice, p.categoria, p.recuperati, p.buttati]);
                });

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Riepilogo');

            } else {
                const filtered = registrazioni.filter(r => r.prodotti && r.prodotti.categoria === tipo);
                const wsData = [['Data', 'Operatore', 'Prodotto', 'Codice', 'Recuperati', 'Buttati']];
                
                filtered.forEach(r => {
                    wsData.push([
                        r.data_registrazione || '',
                        r.dipendenti ? (r.dipendenti.nome + ' ' + r.dipendenti.cognome) : '',
                        r.prodotti ? r.prodotti.nome : '',
                        r.prodotti ? r.prodotti.codice_prodotto : '',
                        r.recuperati || 0,
                        r.buttati || 0
                    ]);
                });

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const label = tipo === 'dolce' ? 'Dolci' : 'Salati';
                XLSX.utils.book_append_sheet(wb, ws, label);
            }

            const fileName = `Mage-Italia-Report-${dataInizio}-${dataFine}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showMessage('reportMessage', '‚úÖ Report scaricato con successo!', 'success');

        } catch (err) {
            console.error('Report error:', err);
            showMessage('reportMessage', '‚ùå Errore: ' + (err.message || 'Errore sconosciuto'), 'error');
        }
    }

    // =========== ADMIN - LOGO ===========
    document.getElementById('logoUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            logoBase64 = event.target.result;
            document.getElementById('logoPreview').src = logoBase64;
        };
        reader.readAsDataURL(file);
    });

    function salvaLogo() {
        if (!logoBase64) {
            showMessage('logoMessage', '‚ö†Ô∏è Seleziona un\'immagine', 'error');
            return;
        }

        localStorage.setItem('mageitaliaLogo', logoBase64);
        document.getElementById('loginLogo').src = logoBase64;
        document.getElementById('appLogo').src = logoBase64;
        
        showMessage('logoMessage', '‚úÖ Logo salvato!', 'success');
    }

    // =========== ADMIN DATA ===========
    async function loadAdminData() {
        await loadOperatoriAdmin();
        await loadDipendentiAdmin();
        await loadProdottiAdmin();
    }

    // =========== UTILITY ===========
    function showMessage(elementId, message, type) {
        const div = document.getElementById(elementId);
        div.className = 'message ' + type;
        div.textContent = message;
        div.style.display = 'block';
        setTimeout(() => { div.style.display = 'none'; }, 4000);
    }

</script>

</body>
</html>

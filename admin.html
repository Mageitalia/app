<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mage Italia - Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #A01E4E; margin-bottom: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: white; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .tab.active { background: #A01E4E; color: white; }
        .content { background: white; padding: 20px; border-radius: 8px; display: none; }
        .content.active { display: block; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; }
        button { padding: 10px 20px; background: #A01E4E; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #6B1B47; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f5f5f5; font-weight: bold; }
        .msg { padding: 10px; margin: 10px 0; border-radius: 4px; display: none; }
        .msg.success { background: #d4edda; color: #155724; display: block; }
        .msg.error { background: #f8d7da; color: #721c24; display: block; }
        .logout { float: right; background: #dc3545; }
        .logout:hover { background: #c82333; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>‚öôÔ∏è Admin - Mage Italia</h1>
        <button class="logout" onclick="logout()">üö™ Logout</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('dipendenti')">üë• Dipendenti</div>
        <div class="tab" onclick="switchTab('prodotti')">üì¶ Prodotti</div>
        <div class="tab" onclick="switchTab('report')">üìä Report</div>
    </div>

    <!-- TAB DIPENDENTI -->
    <div id="dipendenti" class="content active">
        <h2>Dipendenti</h2>
        
        <div class="form-row">
            <div><label>Nome</label><input type="text" id="dipNome"></div>
            <div><label>Cognome</label><input type="text" id="dipCognome"></div>
            <div><label>Punto</label><select id="dipPunto"><option value="pisa">Pisa</option><option value="sesto">Sesto</option><option value="cosenza">Cosenza</option></select></div>
            <div><label>Crea Login</label><select id="dipLogin"><option value="no">No</option><option value="si">Si</option></select></div>
        </div>

        <button onclick="aggiungiDipendente()">‚ûï Aggiungi</button>
        <button onclick="caricaDipendenti()">üîÑ Ricarica</button>

        <div id="dipMsg" class="msg"></div>
        <div id="dipTable"></div>
    </div>

    <!-- TAB PRODOTTI -->
    <div id="prodotti" class="content">
        <h2>Prodotti</h2>
        
        <div class="form-row">
            <div><label>Codice</label><input type="text" id="prodCodice"></div>
            <div><label>Nome</label><input type="text" id="prodNome"></div>
            <div><label>Categoria</label><select id="prodCat"><option value="dolce">Dolce</option><option value="salato">Salato</option></select></div>
            <div><label>Punto</label><select id="prodPunto"><option value="pisa">Pisa</option><option value="sesto">Sesto</option><option value="cosenza">Cosenza</option></select></div>
        </div>

        <button onclick="aggiungiProdotto()">‚ûï Aggiungi</button>
        <button onclick="caricaProdotti()">üîÑ Ricarica</button>

        <div id="prodMsg" class="msg"></div>
        <div id="prodTable"></div>
    </div>

    <!-- TAB REPORT -->
    <div id="report" class="content">
        <h2>Report</h2>
        
        <div class="form-row">
            <div><label>Data Inizio</label><input type="date" id="repInizio"></div>
            <div><label>Data Fine</label><input type="date" id="repFine"></div>
            <div><label>Punto</label><select id="repPunto"><option value="">Tutti</option><option value="pisa">Pisa</option><option value="sesto">Sesto</option><option value="cosenza">Cosenza</option></select></div>
            <div><label>Categoria</label><select id="repCat"><option value="">Tutte</option><option value="dolce">Dolce</option><option value="salato">Salato</option></select></div>
        </div>

        <button onclick="generaExcel()">üì• Excel</button>
        <button onclick="mostraGrafici()">üìä Grafici</button>

        <div id="repMsg" class="msg"></div>
        <div id="grafici" style="display: none;">
            <canvas id="chart1" style="max-height: 300px;"></canvas>
            <canvas id="chart2" style="max-height: 300px;"></canvas>
            <canvas id="chart3" style="max-height: 300px;"></canvas>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://uoeprypjgybmpfstnrih.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvZXByeXBqZ3libXBmc3RucmloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MDcyNDAsImV4cCI6MjA4MDE4MzI0MH0.dDlthk4idy21aWEldrqB1U9-5awh42rC9v6fa0_mFyI';
    
    let sb = null;

    async function init() {
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const { data: { session } } = await sb.auth.getSession();
        if (!session || session.user.user_metadata.role !== 'admin') {
            window.location.href = 'index.html';
        }
    }

    function msg(id, text, type) {
        const el = document.getElementById(id);
        el.className = 'msg ' + type;
        el.textContent = text;
        setTimeout(() => el.className = 'msg', 3000);
    }

    function switchTab(name) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(name).classList.add('active');
        event.target.classList.add('active');
        
        if (name === 'dipendenti') caricaDipendenti();
        else if (name === 'prodotti') caricaProdotti();
    }

    // ===== DIPENDENTI =====
    async function caricaDipendenti() {
        try {
            const { data, error } = await sb
                .from('dipendenti')
                .select('*')
                .order('nome');

            if (error) throw error;

            if (!data || data.length === 0) {
                document.getElementById('dipTable').innerHTML = '<p>Nessun dipendente</p>';
                return;
            }

            let html = '<table><thead><tr><th>Nome</th><th>Cognome</th><th>Punto</th><th>Attivo</th><th>Azione</th></tr></thead><tbody>';
            
            data.forEach(d => {
                html += `<tr>
                    <td>${d.nome}</td>
                    <td>${d.cognome}</td>
                    <td>${d.punto_vendita_id}</td>
                    <td>${d.attivo ? '‚úÖ' : '‚ùå'}</td>
                    <td><button onclick="elimDip(${d.id})" style="background: #dc3545;">üóëÔ∏è</button></td>
                </tr>`;
            });

            document.getElementById('dipTable').innerHTML = html + '</tbody></table>';

        } catch (err) {
            msg('dipMsg', '‚ùå ' + err.message, 'error');
        }
    }

    async function aggiungiDipendente() {
        const nome = document.getElementById('dipNome').value;
        const cognome = document.getElementById('dipCognome').value;
        const punto = document.getElementById('dipPunto').value;
        const creaLogin = document.getElementById('dipLogin').value;

        if (!nome || !cognome) {
            msg('dipMsg', '‚ö†Ô∏è Compila nome e cognome', 'error');
            return;
        }

        try {
            const { error } = await sb.from('dipendenti').insert([{
                nome,
                cognome,
                punto_vendita_id: punto,
                attivo: true
            }]);

            if (error) throw error;

            if (creaLogin === 'si') {
                const user = `${nome.toLowerCase()}.${cognome.toLowerCase()}`;
                msg('dipMsg', `‚úÖ Aggiunto!\nüë§ ${user}`, 'success');
            } else {
                msg('dipMsg', '‚úÖ Aggiunto!', 'success');
            }

            document.getElementById('dipNome').value = '';
            document.getElementById('dipCognome').value = '';
            await caricaDipendenti();

        } catch (err) {
            msg('dipMsg', '‚ùå ' + err.message, 'error');
        }
    }

    async function elimDip(id) {
        if (!confirm('Eliminare?')) return;
        try {
            await sb.from('dipendenti').update({ attivo: false }).eq('id', id);
            msg('dipMsg', '‚úÖ Eliminato', 'success');
            await caricaDipendenti();
        } catch (err) {
            msg('dipMsg', '‚ùå ' + err.message, 'error');
        }
    }

    // ===== PRODOTTI =====
    async function caricaProdotti() {
        try {
            const { data, error } = await sb
                .from('prodotti')
                .select('*')
                .order('nome');

            if (error) throw error;

            if (!data || data.length === 0) {
                document.getElementById('prodTable').innerHTML = '<p>Nessun prodotto</p>';
                return;
            }

            let html = '<table><thead><tr><th>Codice</th><th>Nome</th><th>Cat</th><th>Punto</th><th>Azione</th></tr></thead><tbody>';
            
            data.forEach(p => {
                html += `<tr>
                    <td>${p.codice_prodotto}</td>
                    <td>${p.nome}</td>
                    <td>${p.categoria}</td>
                    <td>${p.punto_vendita_id}</td>
                    <td><button onclick="elimProd(${p.id})" style="background: #dc3545;">üóëÔ∏è</button></td>
                </tr>`;
            });

            document.getElementById('prodTable').innerHTML = html + '</tbody></table>';

        } catch (err) {
            msg('prodMsg', '‚ùå ' + err.message, 'error');
        }
    }

    async function aggiungiProdotto() {
        const codice = document.getElementById('prodCodice').value;
        const nome = document.getElementById('prodNome').value;
        const cat = document.getElementById('prodCat').value;
        const punto = document.getElementById('prodPunto').value;

        if (!codice || !nome) {
            msg('prodMsg', '‚ö†Ô∏è Compila codice e nome', 'error');
            return;
        }

        try {
            await sb.from('prodotti').insert([{
                codice_prodotto: codice,
                nome,
                categoria: cat,
                punto_vendita_id: punto,
                attivo: true
            }]);

            msg('prodMsg', '‚úÖ Aggiunto!', 'success');
            document.getElementById('prodCodice').value = '';
            document.getElementById('prodNome').value = '';
            await caricaProdotti();

        } catch (err) {
            msg('prodMsg', '‚ùå ' + err.message, 'error');
        }
    }

    async function elimProd(id) {
        if (!confirm('Eliminare?')) return;
        try {
            await sb.from('prodotti').update({ attivo: false }).eq('id', id);
            msg('prodMsg', '‚úÖ Eliminato', 'success');
            await caricaProdotti();
        } catch (err) {
            msg('prodMsg', '‚ùå ' + err.message, 'error');
        }
    }

    // ===== REPORT =====
    async function generaExcel() {
        try {
            const inizio = document.getElementById('repInizio').value;
            const fine = document.getElementById('repFine').value;
            const punto = document.getElementById('repPunto').value;
            const cat = document.getElementById('repCat').value;

            if (!inizio || !fine) {
                msg('repMsg', '‚ö†Ô∏è Seleziona date', 'error');
                return;
            }

            msg('repMsg', '‚è≥ Generazione...', 'success');

            let query = sb
                .from('registrazioni_giornaliere')
                .select('data_registrazione, produzione, recuperati, buttati, prodotti(codice_prodotto, nome, categoria, punto_vendita_id)')
                .gte('data_registrazione', inizio)
                .lte('data_registrazione', fine);

            const { data, error } = await query;

            if (error) throw error;

            let filtered = data || [];
            if (punto) filtered = filtered.filter(r => r.prodotti?.punto_vendita_id === punto);
            if (cat) filtered = filtered.filter(r => r.prodotti?.categoria === cat);

            if (filtered.length === 0) {
                msg('repMsg', '‚ö†Ô∏è Nessun dato', 'error');
                return;
            }

            const excel = filtered.map(r => ({
                'Data': r.data_registrazione,
                'Codice': r.prodotti?.codice_prodotto || '‚Äî',
                'Prodotto': r.prodotti?.nome || '‚Äî',
                'Categoria': r.prodotti?.categoria || '‚Äî',
                'Produzione': r.produzione || 0,
                'Recuperati': r.recuperati || 0,
                'Scartati': r.buttati || 0,
                'Totale': (r.produzione || 0) + (r.recuperati || 0) + (r.buttati || 0)
            }));

            const ws = XLSX.utils.json_to_sheet(excel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Report');
            XLSX.writeFile(wb, `Mage-${inizio}.xlsx`);

            msg('repMsg', '‚úÖ Scaricato!', 'success');

        } catch (err) {
            msg('repMsg', '‚ùå ' + err.message, 'error');
        }
    }

    async function mostraGrafici() {
        try {
            const inizio = document.getElementById('repInizio').value;
            const fine = document.getElementById('repFine').value;

            if (!inizio || !fine) {
                msg('repMsg', '‚ö†Ô∏è Seleziona date', 'error');
                return;
            }

            const { data, error } = await sb
                .from('registrazioni_giornaliere')
                .select('id, produzione, recuperati, buttati, prodotti(nome, categoria, punto_vendita_id)')
                .gte('data_registrazione', inizio)
                .lte('data_registrazione', fine);

            if (error || !data || data.length === 0) {
                msg('repMsg', '‚ö†Ô∏è Nessun dato', 'error');
                return;
            }

            const prodotti = {};
            data.forEach(r => {
                const nome = r.prodotti?.nome || '?';
                if (!prodotti[nome]) prodotti[nome] = { prod: 0, rec: 0, scar: 0 };
                prodotti[nome].prod += r.produzione || 0;
                prodotti[nome].rec += r.recuperati || 0;
                prodotti[nome].scar += r.buttati || 0;
            });

            document.getElementById('grafici').style.display = 'block';

            const ctx1 = document.getElementById('chart1').getContext('2d');
            if (window.c1) window.c1.destroy();
            window.c1 = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: Object.keys(prodotti).slice(0, 10),
                    datasets: [
                        { label: 'Prod', data: Object.values(prodotti).slice(0, 10).map(p => p.prod), backgroundColor: '#4169E1' },
                        { label: 'Rec', data: Object.values(prodotti).slice(0, 10).map(p => p.rec), backgroundColor: '#28a745' },
                        { label: 'Scar', data: Object.values(prodotti).slice(0, 10).map(p => p.scar), backgroundColor: '#dc3545' }
                    ]
                },
                options: { responsive: true }
            });

            msg('repMsg', '‚úÖ Grafici creati!', 'success');

        } catch (err) {
            msg('repMsg', '‚ùå ' + err.message, 'error');
        }
    }

    async function logout() {
        await sb.auth.signOut();
        window.location.href = 'index.html';
    }

    window.addEventListener('load', init);
</script>

</body>
</html>
